<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <title>Edmund's Mastermind â€” Billing Portal v2.1</title>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@300;400;500;600;700&family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <!-- Supabase -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <!-- Chart.js for visualizations -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- PapaParse for CSV parsing -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
    <!-- PDF.js for PDF parsing -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <style>
        :root {
            /* Edmund Bogen Brand Colors */
            --brand-primary: #00a8e1;
            --brand-primary-dark: #0090c4;
            --brand-primary-light: #e6f7fc;
            --navy: #1a3e5c;
            --navy-light: #2a5275;
            --navy-dark: #0f2a42;
            --white: #FFFFFF;
            --off-white: #f8fafc;
            --gray-50: #f9fafb;
            --gray-100: #f3f4f6;
            --gray-200: #e5e7eb;
            --gray-300: #d1d5db;
            --gray-400: #9ca3af;
            --gray-500: #6b7280;
            --gray-600: #4b5563;
            --gray-700: #374151;
            --gray-800: #1f2937;
            --success: #059669;
            --success-light: #d1fae5;
            --warning: #d97706;
            --warning-light: #fef3c7;
            --danger: #dc2626;
            --danger-light: #fee2e2;
            --info: #0284c7;
            --info-light: #e0f2fe;
            --shadow-sm: 0 1px 2px 0 rgb(0 0 0 / 0.05);
            --shadow-md: 0 4px 6px -1px rgb(0 0 0 / 0.1);
            --shadow-lg: 0 10px 15px -3px rgb(0 0 0 / 0.1);
            --shadow-xl: 0 20px 25px -5px rgb(0 0 0 / 0.1);
            --radius-sm: 4px;
            --radius-md: 8px;
            --radius-lg: 12px;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            background-color: var(--off-white);
            color: var(--gray-800);
            line-height: 1.6;
            min-height: 100vh;
        }

        h1, h2, h3, h4, h5 {
            font-family: 'Montserrat', sans-serif;
            font-weight: 500;
            letter-spacing: 0.02em;
        }

        /* ============================================
           LOGIN SCREEN
           ============================================ */
        #login-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, var(--navy) 0%, var(--navy-dark) 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }

        #login-screen.hidden {
            display: none;
        }

        .login-container {
            text-align: center;
            padding: 2rem;
        }

        .login-logo {
            color: var(--white);
            font-family: 'Montserrat', sans-serif;
            font-size: 1.75rem;
            font-weight: 300;
            margin-bottom: 0.5rem;
            text-transform: uppercase;
            letter-spacing: 0.15em;
        }

        .login-subtitle {
            color: var(--brand-primary);
            font-size: 0.8rem;
            margin-bottom: 2.5rem;
            letter-spacing: 0.2em;
            text-transform: uppercase;
            font-weight: 500;
        }

        .login-box {
            background: var(--white);
            padding: 2.5rem;
            border-radius: var(--radius-lg);
            box-shadow: var(--shadow-xl);
            width: 100%;
            max-width: 380px;
        }

        .login-box h2 {
            font-size: 1.25rem;
            margin-bottom: 1.5rem;
            color: var(--navy);
            text-transform: uppercase;
            letter-spacing: 0.1em;
        }

        .form-group {
            margin-bottom: 1.25rem;
            text-align: left;
        }

        .form-group label {
            display: block;
            font-size: 0.7rem;
            font-weight: 600;
            color: var(--gray-600);
            text-transform: uppercase;
            letter-spacing: 0.05em;
            margin-bottom: 0.5rem;
        }

        .form-group input,
        .form-group select {
            width: 100%;
            padding: 0.875rem 1rem;
            border: 1px solid var(--gray-300);
            border-radius: var(--radius-md);
            font-size: 1rem;
            font-family: inherit;
            transition: all 0.2s;
        }

        .form-group input:focus,
        .form-group select:focus {
            outline: none;
            border-color: var(--brand-primary);
            box-shadow: 0 0 0 3px rgba(0, 168, 225, 0.15);
        }

        .login-error {
            color: var(--danger);
            font-size: 0.875rem;
            margin-bottom: 1rem;
            display: none;
        }

        .login-error.show {
            display: block;
        }

        /* ============================================
           BUTTONS
           ============================================ */
        .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            padding: 0.75rem 1.25rem;
            border: none;
            border-radius: var(--radius-md);
            font-size: 0.875rem;
            font-weight: 600;
            font-family: inherit;
            cursor: pointer;
            transition: all 0.2s;
            text-decoration: none;
        }

        .btn:active {
            transform: scale(0.98);
        }

        .btn-primary {
            background: var(--brand-primary);
            color: var(--white);
            text-transform: uppercase;
            letter-spacing: 0.08em;
        }

        .btn-primary:hover {
            background: var(--brand-primary-dark);
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(0, 168, 225, 0.3);
        }

        .btn-secondary {
            background: var(--gray-100);
            color: var(--gray-700);
        }

        .btn-secondary:hover {
            background: var(--gray-200);
        }

        .btn-outline {
            background: transparent;
            border: 1px solid var(--gray-300);
            color: var(--gray-600);
        }

        .btn-outline:hover {
            background: var(--gray-50);
            border-color: var(--gray-400);
        }

        .btn-danger {
            background: var(--danger);
            color: var(--white);
        }

        .btn-danger:hover {
            background: #b91c1c;
        }

        .btn-success {
            background: var(--success);
            color: var(--white);
        }

        .btn-success:hover {
            background: #047857;
        }

        .btn-sm {
            padding: 0.5rem 0.875rem;
            font-size: 0.75rem;
        }

        .btn-lg {
            padding: 1rem 2rem;
            font-size: 1rem;
        }

        .btn-block {
            width: 100%;
        }

        /* ============================================
           MAIN APP LAYOUT
           ============================================ */
        #main-app {
            display: none;
            min-height: 100vh;
        }

        #main-app.active {
            display: block;
        }

        /* Header */
        .app-header {
            background: var(--navy);
            color: var(--white);
            padding: 0;
            position: sticky;
            top: 0;
            z-index: 100;
            box-shadow: var(--shadow-md);
        }

        .header-top {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 1rem 2rem;
            border-bottom: 1px solid var(--navy-light);
        }

        .header-brand {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .header-logo {
            font-family: 'Montserrat', sans-serif;
            font-size: 1.25rem;
            font-weight: 300;
            text-transform: uppercase;
            letter-spacing: 0.12em;
        }

        .header-divider {
            width: 1px;
            height: 24px;
            background: var(--navy-light);
        }

        .header-title {
            font-size: 0.75rem;
            font-weight: 500;
            text-transform: uppercase;
            letter-spacing: 0.15em;
            color: var(--brand-primary);
        }

        .header-right {
            display: flex;
            align-items: center;
            gap: 1.5rem;
        }

        .sync-status {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 0.75rem;
            color: var(--gray-400);
        }

        .sync-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: var(--success);
        }

        .sync-dot.offline {
            background: var(--warning);
        }

        .sync-dot.error {
            background: var(--danger);
        }

        .sync-dot.syncing {
            background: var(--brand-primary);
            animation: pulse 1s ease-in-out infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; transform: scale(1); }
            50% { opacity: 0.5; transform: scale(1.2); }
        }

        .user-menu {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            cursor: pointer;
            padding: 0.5rem 1rem;
            border-radius: var(--radius-md);
            transition: background 0.2s;
        }

        .user-menu:hover {
            background: var(--navy-light);
        }

        .user-avatar {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background: var(--brand-primary);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.875rem;
            font-weight: 600;
        }

        .user-name {
            font-size: 0.875rem;
            font-weight: 500;
        }

        .user-role {
            font-size: 0.7rem;
            color: var(--gray-400);
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .logout-btn {
            background: transparent;
            border: 1px solid var(--navy-light);
            color: var(--gray-400);
            padding: 0.5rem 1rem;
            border-radius: var(--radius-md);
            font-size: 0.75rem;
            cursor: pointer;
            transition: all 0.2s;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .logout-btn:hover {
            background: var(--navy-light);
            color: var(--white);
            border-color: transparent;
        }

        /* Navigation */
        .main-nav {
            display: flex;
            padding: 0 2rem;
            gap: 0;
            overflow-x: auto;
        }

        .nav-item {
            padding: 1rem 1.5rem;
            font-size: 0.8rem;
            font-weight: 500;
            color: var(--gray-400);
            text-transform: uppercase;
            letter-spacing: 0.08em;
            cursor: pointer;
            border-bottom: 3px solid transparent;
            transition: all 0.2s;
            white-space: nowrap;
        }

        .nav-item:hover {
            color: var(--white);
            background: var(--navy-light);
        }

        .nav-item.active {
            color: var(--white);
            border-bottom-color: var(--brand-primary);
        }

        /* Main Content */
        .main-content {
            padding: 2rem;
            max-width: 1600px;
            margin: 0 auto;
        }

        /* Page Sections */
        .page-content {
            display: none;
            animation: fadeIn 0.3s ease;
        }

        .page-content.active {
            display: block;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Page Header */
        .page-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 2rem;
        }

        .page-title {
            font-size: 1.5rem;
            font-weight: 500;
            color: var(--navy);
            text-transform: uppercase;
            letter-spacing: 0.08em;
        }

        .page-subtitle {
            font-size: 0.875rem;
            color: var(--gray-500);
            margin-top: 0.25rem;
            text-transform: none;
            letter-spacing: 0;
            font-weight: 400;
        }

        /* ============================================
           CARDS & STATS
           ============================================ */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        .stat-card {
            background: var(--white);
            border-radius: var(--radius-lg);
            padding: 1.5rem;
            box-shadow: var(--shadow-sm);
            border: 1px solid var(--gray-200);
            transition: all 0.2s;
        }

        .stat-card:hover {
            box-shadow: var(--shadow-md);
            transform: translateY(-2px);
        }

        .stat-card.highlight {
            border-left: 4px solid var(--brand-primary);
        }

        .stat-card.success {
            border-left: 4px solid var(--success);
        }

        .stat-card.warning {
            border-left: 4px solid var(--warning);
        }

        .stat-card.danger {
            border-left: 4px solid var(--danger);
        }

        .stat-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 0.75rem;
        }

        .stat-label {
            font-size: 0.7rem;
            font-weight: 600;
            color: var(--gray-500);
            text-transform: uppercase;
            letter-spacing: 0.08em;
        }

        .stat-icon {
            width: 36px;
            height: 36px;
            border-radius: var(--radius-md);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.25rem;
        }

        .stat-icon.blue {
            background: var(--brand-primary-light);
            color: var(--brand-primary);
        }

        .stat-icon.green {
            background: var(--success-light);
            color: var(--success);
        }

        .stat-icon.yellow {
            background: var(--warning-light);
            color: var(--warning);
        }

        .stat-icon.red {
            background: var(--danger-light);
            color: var(--danger);
        }

        .stat-value {
            font-size: 2rem;
            font-weight: 600;
            color: var(--navy);
            line-height: 1.2;
        }

        .stat-value.currency::before {
            content: '$';
            font-size: 1.25rem;
            font-weight: 400;
            color: var(--gray-500);
        }

        .stat-change {
            display: inline-flex;
            align-items: center;
            gap: 0.25rem;
            font-size: 0.75rem;
            font-weight: 600;
            margin-top: 0.5rem;
            padding: 0.25rem 0.5rem;
            border-radius: var(--radius-sm);
        }

        .stat-change.up {
            background: var(--success-light);
            color: var(--success);
        }

        .stat-change.down {
            background: var(--danger-light);
            color: var(--danger);
        }

        .stat-change.neutral {
            background: var(--gray-100);
            color: var(--gray-600);
        }

        /* ============================================
           CONTENT CARDS
           ============================================ */
        .card {
            background: var(--white);
            border-radius: var(--radius-lg);
            box-shadow: var(--shadow-sm);
            border: 1px solid var(--gray-200);
            overflow: hidden;
        }

        .card-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 1.25rem 1.5rem;
            border-bottom: 1px solid var(--gray-200);
            background: var(--gray-50);
        }

        .card-title {
            font-size: 0.875rem;
            font-weight: 600;
            color: var(--navy);
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .card-body {
            padding: 1.5rem;
        }

        .card-footer {
            padding: 1rem 1.5rem;
            border-top: 1px solid var(--gray-200);
            background: var(--gray-50);
        }

        /* ============================================
           TABLES
           ============================================ */
        .table-container {
            overflow-x: auto;
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        th {
            text-align: left;
            padding: 0.875rem 1rem;
            font-size: 0.7rem;
            font-weight: 600;
            color: var(--gray-500);
            text-transform: uppercase;
            letter-spacing: 0.05em;
            background: var(--gray-50);
            border-bottom: 1px solid var(--gray-200);
        }

        td {
            padding: 1rem;
            font-size: 0.875rem;
            border-bottom: 1px solid var(--gray-100);
            vertical-align: middle;
        }

        tr:hover {
            background: var(--gray-50);
        }

        tr:last-child td {
            border-bottom: none;
        }

        /* ============================================
           BADGES
           ============================================ */
        .badge {
            display: inline-flex;
            align-items: center;
            padding: 0.25rem 0.75rem;
            border-radius: 9999px;
            font-size: 0.7rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.03em;
        }

        .badge-success {
            background: var(--success-light);
            color: var(--success);
        }

        .badge-warning {
            background: var(--warning-light);
            color: var(--warning);
        }

        .badge-danger {
            background: var(--danger-light);
            color: var(--danger);
        }

        .badge-info {
            background: var(--info-light);
            color: var(--info);
        }

        .badge-neutral {
            background: var(--gray-100);
            color: var(--gray-600);
        }

        /* ============================================
           ALERTS
           ============================================ */
        .alert {
            display: flex;
            align-items: flex-start;
            gap: 1rem;
            padding: 1rem 1.25rem;
            border-radius: var(--radius-md);
            margin-bottom: 1rem;
        }

        .alert-icon {
            font-size: 1.25rem;
            flex-shrink: 0;
        }

        .alert-content {
            flex: 1;
        }

        .alert-title {
            font-weight: 600;
            margin-bottom: 0.25rem;
        }

        .alert-message {
            font-size: 0.875rem;
            opacity: 0.9;
        }

        .alert-danger {
            background: var(--danger-light);
            color: var(--danger);
            border: 1px solid #fca5a5;
        }

        .alert-warning {
            background: var(--warning-light);
            color: #92400e;
            border: 1px solid #fcd34d;
        }

        .alert-success {
            background: var(--success-light);
            color: #065f46;
            border: 1px solid #6ee7b7;
        }

        .alert-info {
            background: var(--info-light);
            color: #075985;
            border: 1px solid #7dd3fc;
        }

        /* ============================================
           GRID LAYOUTS
           ============================================ */
        .grid-2 {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 1.5rem;
        }

        .grid-3 {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 1.5rem;
        }

        .grid-4 {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 1.5rem;
        }

        @media (max-width: 1200px) {
            .grid-4 {
                grid-template-columns: repeat(2, 1fr);
            }
            .grid-3 {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        @media (max-width: 768px) {
            .grid-2, .grid-3, .grid-4 {
                grid-template-columns: 1fr;
            }
            .main-content {
                padding: 1rem;
            }
            .header-top {
                padding: 1rem;
            }
            .main-nav {
                padding: 0 1rem;
            }
            .page-header {
                flex-direction: column;
                align-items: flex-start;
                gap: 1rem;
            }
        }

        /* ============================================
           DASHBOARD SPECIFIC
           ============================================ */
        .dashboard-grid {
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: 1.5rem;
        }

        @media (max-width: 1200px) {
            .dashboard-grid {
                grid-template-columns: 1fr;
            }
        }

        .recent-list {
            list-style: none;
        }

        .recent-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 1rem 0;
            border-bottom: 1px solid var(--gray-100);
        }

        .recent-item:last-child {
            border-bottom: none;
        }

        .recent-info {
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .recent-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: var(--brand-primary-light);
            color: var(--brand-primary);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            font-size: 0.875rem;
        }

        .recent-name {
            font-weight: 500;
            color: var(--gray-800);
        }

        .recent-detail {
            font-size: 0.75rem;
            color: var(--gray-500);
        }

        .recent-amount {
            font-weight: 600;
            font-size: 0.875rem;
        }

        .recent-amount.positive {
            color: var(--success);
        }

        .recent-amount.negative {
            color: var(--danger);
        }

        /* General positive/negative styles */
        .positive {
            color: var(--success);
        }

        .negative {
            color: var(--danger);
        }

        .stat-value.positive {
            color: var(--success);
        }

        .stat-value.negative {
            color: var(--danger);
        }

        td.positive {
            color: var(--success);
            font-weight: 600;
        }

        td.negative {
            color: var(--danger);
            font-weight: 600;
        }

        /* Utility margin classes */
        .mt-2 {
            margin-top: 1.5rem;
        }

        .mb-2 {
            margin-bottom: 1.5rem;
        }

        /* Quick Actions */
        .quick-actions {
            display: flex;
            gap: 1rem;
            flex-wrap: wrap;
        }

        /* Empty State */
        .empty-state {
            text-align: center;
            padding: 3rem 2rem;
            color: var(--gray-500);
        }

        .empty-state-icon {
            font-size: 3rem;
            margin-bottom: 1rem;
            opacity: 0.5;
        }

        .empty-state-title {
            font-size: 1.125rem;
            font-weight: 600;
            color: var(--gray-700);
            margin-bottom: 0.5rem;
        }

        .empty-state-message {
            font-size: 0.875rem;
            margin-bottom: 1.5rem;
        }

        /* ============================================
           MODAL
           ============================================ */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            padding: 2rem;
        }

        .modal-overlay.active {
            display: flex;
        }

        .modal {
            background: var(--white);
            border-radius: var(--radius-lg);
            box-shadow: var(--shadow-xl);
            width: 100%;
            max-width: 500px;
            max-height: 90vh;
            overflow: auto;
            animation: modalIn 0.2s ease;
        }

        @keyframes modalIn {
            from {
                opacity: 0;
                transform: scale(0.95) translateY(-20px);
            }
            to {
                opacity: 1;
                transform: scale(1) translateY(0);
            }
        }

        .modal-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 1.25rem 1.5rem;
            border-bottom: 1px solid var(--gray-200);
        }

        .modal-title {
            font-size: 1rem;
            font-weight: 600;
            color: var(--navy);
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .modal-close {
            background: none;
            border: none;
            font-size: 1.5rem;
            color: var(--gray-400);
            cursor: pointer;
            padding: 0.25rem;
            line-height: 1;
            transition: color 0.2s;
        }

        .modal-close:hover {
            color: var(--gray-700);
        }

        .modal-body {
            padding: 1.5rem;
        }

        .modal-footer {
            display: flex;
            justify-content: flex-end;
            gap: 0.75rem;
            padding: 1rem 1.5rem;
            border-top: 1px solid var(--gray-200);
            background: var(--gray-50);
        }

        /* ============================================
           SETTINGS PAGE
           ============================================ */
        .settings-section {
            margin-bottom: 2rem;
        }

        .settings-title {
            font-size: 1rem;
            font-weight: 600;
            color: var(--navy);
            margin-bottom: 1rem;
            padding-bottom: 0.5rem;
            border-bottom: 2px solid var(--brand-primary);
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .user-card {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 1rem;
            background: var(--gray-50);
            border-radius: var(--radius-md);
            margin-bottom: 0.75rem;
        }

        .user-card-info {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .user-card-avatar {
            width: 48px;
            height: 48px;
            border-radius: 50%;
            background: var(--brand-primary);
            color: var(--white);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.125rem;
            font-weight: 600;
        }

        .user-card-name {
            font-weight: 600;
            color: var(--gray-800);
        }

        .user-card-role {
            font-size: 0.75rem;
            color: var(--gray-500);
            text-transform: uppercase;
            letter-spacing: 0.03em;
        }

        /* ============================================
           UTILITIES
           ============================================ */
        .text-center { text-align: center; }
        .text-right { text-align: right; }
        .text-muted { color: var(--gray-500); }
        .text-success { color: var(--success); }
        .text-danger { color: var(--danger); }
        .text-warning { color: var(--warning); }
        .mb-0 { margin-bottom: 0; }
        .mb-1 { margin-bottom: 0.5rem; }
        .mb-2 { margin-bottom: 1rem; }
        .mb-3 { margin-bottom: 1.5rem; }
        .mb-4 { margin-bottom: 2rem; }
        .mt-2 { margin-top: 1rem; }
        .mt-3 { margin-top: 1.5rem; }
        .hidden { display: none !important; }

        /* ============================================
           BOOKKEEPING HERO IMAGE
           ============================================ */
        .bookkeeping-hero {
            position: relative;
            border-radius: var(--radius-lg);
            overflow: hidden;
            margin-bottom: 2rem;
            background: linear-gradient(135deg, var(--navy) 0%, var(--navy-dark) 100%);
        }

        .bookkeeping-hero img {
            width: 100%;
            max-height: 200px;
            object-fit: cover;
            object-position: center 40%;
            opacity: 0.9;
        }

        .bookkeeping-hero-overlay {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            padding: 1.5rem 2rem;
            background: linear-gradient(to top, rgba(15, 42, 66, 0.95) 0%, rgba(15, 42, 66, 0.7) 50%, transparent 100%);
        }

        .bookkeeping-hero-text {
            color: var(--white);
            font-family: 'Montserrat', sans-serif;
            font-size: 1.5rem;
            font-weight: 300;
            text-transform: uppercase;
            letter-spacing: 0.15em;
        }

        .bookkeeping-hero-subtext {
            color: var(--brand-primary);
            font-size: 0.8rem;
            text-transform: uppercase;
            letter-spacing: 0.2em;
            margin-top: 0.25rem;
        }

        /* ============================================
           PAGINATION
           ============================================ */
        .pagination {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            margin-top: 1.5rem;
            padding: 1rem;
            border-top: 1px solid var(--gray-200);
        }

        .pagination-btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            min-width: 36px;
            height: 36px;
            padding: 0 0.75rem;
            border: 1px solid var(--gray-300);
            border-radius: var(--radius-md);
            background: var(--white);
            color: var(--gray-700);
            font-size: 0.875rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
        }

        .pagination-btn:hover:not(:disabled) {
            background: var(--gray-50);
            border-color: var(--brand-primary);
            color: var(--brand-primary);
        }

        .pagination-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .pagination-btn.active {
            background: var(--brand-primary);
            border-color: var(--brand-primary);
            color: var(--white);
        }

        .pagination-info {
            font-size: 0.875rem;
            color: var(--gray-500);
            margin: 0 1rem;
        }

        /* ============================================
           REPORTS CHARTS
           ============================================ */
        .reports-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 1.5rem;
        }

        @media (max-width: 1024px) {
            .reports-grid {
                grid-template-columns: 1fr;
            }
        }

        .chart-container {
            position: relative;
            height: 300px;
            padding: 1rem;
        }

        .report-stat-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 1rem;
            margin-bottom: 1.5rem;
        }

        @media (max-width: 768px) {
            .report-stat-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        .report-stat-card {
            background: var(--white);
            border-radius: var(--radius-md);
            padding: 1.25rem;
            border: 1px solid var(--gray-200);
            text-align: center;
        }

        .report-stat-value {
            font-size: 1.75rem;
            font-weight: 600;
            color: var(--navy);
            margin-bottom: 0.25rem;
        }

        .report-stat-value.positive { color: var(--success); }
        .report-stat-value.negative { color: var(--danger); }

        .report-stat-label {
            font-size: 0.75rem;
            color: var(--gray-500);
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .churn-metric {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 1rem;
            border-bottom: 1px solid var(--gray-100);
        }

        .churn-metric:last-child {
            border-bottom: none;
        }

        .churn-label {
            font-size: 0.875rem;
            color: var(--gray-600);
        }

        .churn-value {
            font-size: 1.25rem;
            font-weight: 600;
        }
    </style>
</head>
<body>
    <!-- ============================================
         LOGIN SCREEN
         ============================================ -->
    <div id="login-screen">
        <div class="login-container">
            <div class="login-logo">Edmund's Mastermind</div>
            <div class="login-subtitle">Billing Portal</div>
            <div class="login-box">
                <h2>Sign In</h2>
                <form id="login-form">
                    <div class="form-group">
                        <label for="login-email">Email</label>
                        <input type="email" id="login-email" placeholder="Enter your email" required>
                    </div>
                    <div class="form-group">
                        <label for="login-password">Password</label>
                        <input type="password" id="login-password" placeholder="Enter password" required>
                    </div>
                    <div class="login-error" id="login-error">Invalid credentials. Please try again.</div>
                    <button type="submit" class="btn btn-primary btn-block" id="login-btn">Sign In</button>
                </form>
                <div style="margin-top: 1rem; text-align: center; font-size: 0.8rem; color: #64748b;">
                    Secure login powered by Supabase
                </div>
            </div>
        </div>
    </div>

    <!-- ============================================
         MAIN APPLICATION
         ============================================ -->
    <div id="main-app">
        <!-- Header -->
        <header class="app-header">
            <div class="header-top">
                <div class="header-brand">
                    <span class="header-logo">Edmund's Mastermind</span>
                    <span class="header-divider"></span>
                    <span class="header-title">Billing Portal</span>
                </div>
                <div class="header-right">
                    <div class="sync-status" onclick="triggerManualSync()" style="cursor: pointer;" title="Click to sync now">
                        <span class="sync-dot" id="sync-dot"></span>
                        <span id="sync-text">Synced</span>
                    </div>
                    <div class="user-menu" id="user-menu">
                        <div class="user-avatar" id="user-avatar">EB</div>
                        <div>
                            <div class="user-name" id="user-display-name">Edmund Bogen</div>
                            <div class="user-role" id="user-role">Admin</div>
                        </div>
                    </div>
                    <button class="logout-btn" onclick="logout()">Logout</button>
                </div>
            </div>
            <nav class="main-nav">
                <div class="nav-item active" data-tab="dashboard">Dashboard</div>
                <div class="nav-item" data-tab="members">Members</div>
                <div class="nav-item" data-tab="reconciliation">Reconciliation</div>
                <div class="nav-item" data-tab="bookkeeping">Bookkeeping</div>
                <div class="nav-item" data-tab="reports">Reports</div>
                <div class="nav-item" data-tab="settings">Settings</div>
            </nav>
        </header>

        <!-- Main Content -->
        <main class="main-content">
            <!-- ============================================
                 DASHBOARD TAB
                 ============================================ -->
            <div class="page-content active" id="page-dashboard">
                <div class="page-header">
                    <div>
                        <h1 class="page-title">Dashboard</h1>
                        <p class="page-subtitle">Overview of your mastermind billing and finances</p>
                    </div>
                    <div class="quick-actions">
                        <button class="btn btn-primary" onclick="showTab('reconciliation')">Run Reconciliation</button>
                        <button class="btn btn-secondary" onclick="showTab('members')">Import Members</button>
                    </div>
                </div>

                <!-- Stats Cards -->
                <div class="stats-grid">
                    <div class="stat-card highlight">
                        <div class="stat-header">
                            <span class="stat-label">Monthly Recurring Revenue</span>
                            <div class="stat-icon blue">$</div>
                        </div>
                        <div class="stat-value currency" id="stat-mrr">0</div>
                        <span class="stat-change up" id="mrr-change">+0% vs last month</span>
                    </div>
                    <div class="stat-card success">
                        <div class="stat-header">
                            <span class="stat-label">Active Members</span>
                            <div class="stat-icon green">&#128101;</div>
                        </div>
                        <div class="stat-value" id="stat-members">0</div>
                        <span class="stat-change neutral" id="members-change">0 new this month</span>
                    </div>
                    <div class="stat-card warning">
                        <div class="stat-header">
                            <span class="stat-label">Outstanding Balance</span>
                            <div class="stat-icon yellow">&#9888;</div>
                        </div>
                        <div class="stat-value currency" id="stat-outstanding">0</div>
                        <span class="stat-change neutral" id="outstanding-count">0 members</span>
                    </div>
                    <div class="stat-card danger">
                        <div class="stat-header">
                            <span class="stat-label">Failed Payments</span>
                            <div class="stat-icon red">&#10006;</div>
                        </div>
                        <div class="stat-value" id="stat-failed">0</div>
                        <span class="stat-change neutral" id="failed-amount">$0 this month</span>
                    </div>
                </div>

                <!-- Alerts Section -->
                <div id="dashboard-alerts" class="mb-3">
                    <!-- Alerts will be dynamically inserted here -->
                </div>

                <!-- Dashboard Grid -->
                <div class="dashboard-grid">
                    <!-- Recent Transactions -->
                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title">Recent Transactions</h3>
                            <button class="btn btn-sm btn-outline" onclick="showTab('bookkeeping')">View All</button>
                        </div>
                        <div class="card-body">
                            <ul class="recent-list" id="recent-transactions">
                                <li class="empty-state">
                                    <div class="empty-state-icon">&#128179;</div>
                                    <div class="empty-state-title">No transactions yet</div>
                                    <div class="empty-state-message">Import your Stripe data to see transactions here</div>
                                </li>
                            </ul>
                        </div>
                    </div>

                    <!-- Quick Stats / Discrepancies -->
                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title">Billing Issues</h3>
                            <span class="badge badge-danger" id="issues-count">0</span>
                        </div>
                        <div class="card-body">
                            <ul class="recent-list" id="billing-issues">
                                <li class="empty-state">
                                    <div class="empty-state-icon">&#9989;</div>
                                    <div class="empty-state-title">All clear!</div>
                                    <div class="empty-state-message">No billing issues found. Run a reconciliation to check for discrepancies.</div>
                                </li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>

            <!-- ============================================
                 MEMBERS TAB
                 ============================================ -->
            <div class="page-content" id="page-members">
                <div class="page-header">
                    <div>
                        <h1 class="page-title">Members</h1>
                        <p class="page-subtitle">Manage your mastermind members and subscriptions</p>
                    </div>
                    <div class="quick-actions">
                        <button class="btn btn-primary" onclick="openModal('import-kajabi-modal')">Import Kajabi CSV</button>
                        <button class="btn btn-secondary" onclick="exportMembers()">Export</button>
                    </div>
                </div>

                <!-- Member Stats -->
                <div class="stats-grid mb-3">
                    <div class="stat-card">
                        <div class="stat-label">Total Members</div>
                        <div class="stat-value" id="members-total">0</div>
                    </div>
                    <div class="stat-card success">
                        <div class="stat-label">Active</div>
                        <div class="stat-value" id="members-active">0</div>
                    </div>
                    <div class="stat-card warning">
                        <div class="stat-label">Past Due</div>
                        <div class="stat-value" id="members-pastdue">0</div>
                    </div>
                    <div class="stat-card danger">
                        <div class="stat-label">Canceled This Month</div>
                        <div class="stat-value" id="members-canceled">0</div>
                    </div>
                </div>

                <!-- Members Table -->
                <div class="card">
                    <div class="card-header">
                        <div style="display: flex; gap: 1rem; align-items: center;">
                            <input type="text" id="member-search" placeholder="Search by name or email..." style="padding: 0.5rem 1rem; border: 1px solid var(--gray-300); border-radius: var(--radius-md); width: 250px;">
                            <select id="member-status-filter" style="padding: 0.5rem 1rem; border: 1px solid var(--gray-300); border-radius: var(--radius-md);">
                                <option value="">All Statuses</option>
                                <option value="active">Active</option>
                                <option value="past_due">Past Due</option>
                                <option value="canceled">Canceled</option>
                                <option value="trialing">Trialing</option>
                            </select>
                        </div>
                    </div>
                    <div class="table-container">
                        <table>
                            <thead>
                                <tr>
                                    <th>Name</th>
                                    <th>Email</th>
                                    <th>Plan</th>
                                    <th>Amount</th>
                                    <th>Status</th>
                                    <th>Last Payment</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="members-table-body">
                                <tr>
                                    <td colspan="7" class="text-center text-muted" style="padding: 3rem;">
                                        No members yet. Import your Kajabi CSV to get started.
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- ============================================
                 RECONCILIATION TAB
                 ============================================ -->
            <div class="page-content" id="page-reconciliation">
                <div class="page-header">
                    <div>
                        <h1 class="page-title">Reconciliation</h1>
                        <p class="page-subtitle">Match Kajabi members with Stripe payments and identify discrepancies</p>
                    </div>
                </div>

                <!-- Import Section -->
                <div class="grid-3 mb-3">
                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title">Kajabi Export</h3>
                        </div>
                        <div class="card-body text-center">
                            <div class="empty-state-icon">&#128196;</div>
                            <p class="text-muted mb-2">Last import: <span id="kajabi-last-import">Never</span></p>
                            <button class="btn btn-primary btn-sm" onclick="openModal('import-kajabi-modal')">Upload CSV</button>
                        </div>
                    </div>
                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title">Stripe: REIGNation</h3>
                        </div>
                        <div class="card-body text-center">
                            <div class="empty-state-icon">&#128179;</div>
                            <p class="text-muted mb-2">Last import: <span id="stripe1-last-import">Never</span></p>
                            <button class="btn btn-primary btn-sm" onclick="openModal('import-stripe1-modal')">Upload CSV</button>
                        </div>
                    </div>
                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title">Stripe: Coaching</h3>
                        </div>
                        <div class="card-body text-center">
                            <div class="empty-state-icon">&#128179;</div>
                            <p class="text-muted mb-2">Last import: <span id="stripe2-last-import">Never</span></p>
                            <button class="btn btn-primary btn-sm" onclick="openModal('import-stripe2-modal')">Upload CSV</button>
                        </div>
                    </div>
                </div>

                <!-- Run Reconciliation -->
                <div class="card mb-3">
                    <div class="card-body text-center">
                        <button class="btn btn-primary btn-lg" onclick="runReconciliation()">Run Reconciliation</button>
                        <p class="text-muted mt-2">Compare Kajabi members against Stripe payments and identify issues</p>
                    </div>
                </div>

                <!-- Discrepancies Table -->
                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">Discrepancies <span id="discrepancy-count" style="font-weight: 400; color: var(--gray-500);"></span></h3>
                        <div style="display: flex; gap: 0.75rem; align-items: center;">
                            <select id="discrepancy-filter" style="padding: 0.5rem 1rem; border: 1px solid var(--gray-300); border-radius: var(--radius-md);" onchange="renderDiscrepanciesTable()">
                                <option value="">All Issues</option>
                                <option value="missing_stripe_payment">Missing Payment</option>
                                <option value="failed_payment">Failed Payment</option>
                                <option value="amount_mismatch">Amount Mismatch</option>
                                <option value="missing_kajabi_record">Not in Kajabi</option>
                            </select>
                            <select id="discrepancy-per-page" style="padding: 0.5rem 1rem; border: 1px solid var(--gray-300); border-radius: var(--radius-md);" onchange="changeDiscrepancyPageSize()">
                                <option value="10">10 per page</option>
                                <option value="25">25 per page</option>
                                <option value="50">50 per page</option>
                                <option value="100">100 per page</option>
                            </select>
                        </div>
                    </div>
                    <div class="table-container">
                        <table>
                            <thead>
                                <tr>
                                    <th>Member</th>
                                    <th>Issue Type</th>
                                    <th>Expected</th>
                                    <th>Actual</th>
                                    <th>Status</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="discrepancies-table-body">
                                <tr>
                                    <td colspan="6" class="text-center text-muted" style="padding: 3rem;">
                                        No discrepancies found. Run a reconciliation to check for issues.
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                    <!-- Pagination -->
                    <div class="pagination" id="discrepancy-pagination" style="display: none;">
                        <button class="pagination-btn" onclick="goToDiscrepancyPage('first')" id="disc-page-first">&laquo;</button>
                        <button class="pagination-btn" onclick="goToDiscrepancyPage('prev')" id="disc-page-prev">&lsaquo;</button>
                        <span class="pagination-info" id="disc-page-info">Page 1 of 1</span>
                        <button class="pagination-btn" onclick="goToDiscrepancyPage('next')" id="disc-page-next">&rsaquo;</button>
                        <button class="pagination-btn" onclick="goToDiscrepancyPage('last')" id="disc-page-last">&raquo;</button>
                    </div>
                </div>
            </div>

            <!-- ============================================
                 BOOKKEEPING TAB
                 ============================================ -->
            <div class="page-content" id="page-bookkeeping">
                <!-- Hero Image -->
                <div class="bookkeeping-hero">
                    <img src="edmund-books-web.jpg" alt="Edmund's Bookkeeping">
                    <div class="bookkeeping-hero-overlay">
                        <div class="bookkeeping-hero-text">Edmund's Books</div>
                        <div class="bookkeeping-hero-subtext">Stay calm. Stay organized.</div>
                    </div>
                </div>

                <div class="page-header">
                    <div>
                        <h1 class="page-title">Bookkeeping</h1>
                        <p class="page-subtitle">Track expenses, income, and generate financial reports</p>
                    </div>
                    <div class="quick-actions">
                        <button class="btn btn-primary" onclick="openModal('add-transaction-modal')">Add Transaction</button>
                        <button class="btn btn-secondary" onclick="openModal('import-chase-modal')">Import Chase Statement</button>
                    </div>
                </div>

                <!-- P&L Summary Cards -->
                <div class="stats-grid" id="pl-stats">
                    <div class="stat-card">
                        <div class="stat-header">
                            <span class="stat-title">Total Income</span>
                            <span class="stat-period" id="pl-period">This Month</span>
                        </div>
                        <div class="stat-value positive" id="stat-total-income">$0</div>
                        <div class="stat-footer">
                            <span id="income-txn-count">0 deposits</span>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-header">
                            <span class="stat-title">Total Expenses</span>
                        </div>
                        <div class="stat-value negative" id="stat-total-expenses">$0</div>
                        <div class="stat-footer">
                            <span id="expense-txn-count">0 transactions</span>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-header">
                            <span class="stat-title">Net Profit/Loss</span>
                        </div>
                        <div class="stat-value" id="stat-net-pl">$0</div>
                        <div class="stat-footer">
                            <span id="pl-margin">0% margin</span>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-header">
                            <span class="stat-title">Stripe Matches</span>
                        </div>
                        <div class="stat-value" id="stat-stripe-matches">0/0</div>
                        <div class="stat-footer">
                            <span id="unmatched-payouts">0 unmatched payouts</span>
                        </div>
                    </div>
                </div>

                <!-- Period Selector -->
                <div class="card mb-2">
                    <div class="card-body" style="padding: 1rem 1.5rem;">
                        <div style="display: flex; align-items: center; gap: 1rem; flex-wrap: wrap;">
                            <label style="font-size: 0.875rem; font-weight: 500;">Period:</label>
                            <select id="pl-period-select" style="padding: 0.5rem 1rem; border: 1px solid var(--gray-300); border-radius: var(--radius-md);" onchange="refreshBookkeeping()">
                                <option value="this_month">This Month</option>
                                <option value="last_month">Last Month</option>
                                <option value="this_quarter">This Quarter</option>
                                <option value="this_year">This Year</option>
                                <option value="all_time">All Time</option>
                            </select>
                            <button class="btn btn-sm btn-outline" onclick="matchStripePayouts()">Match Stripe Payouts</button>
                            <button class="btn btn-sm btn-outline" onclick="exportPLReport()">Export P&L Report</button>
                        </div>
                    </div>
                </div>

                <!-- Main Content Grid -->
                <div class="grid-2">
                    <!-- Transactions Table -->
                    <div class="card" style="grid-column: span 2;">
                        <div class="card-header">
                            <h3 class="card-title">Bank Transactions</h3>
                            <div style="display: flex; gap: 0.5rem; align-items: center;">
                                <input type="text" id="txn-search" placeholder="Search transactions..." style="padding: 0.5rem 1rem; border: 1px solid var(--gray-300); border-radius: var(--radius-md); width: 200px;" oninput="filterBankTransactions()">
                                <select id="txn-type-filter" style="padding: 0.5rem 1rem; border: 1px solid var(--gray-300); border-radius: var(--radius-md);" onchange="filterBankTransactions()">
                                    <option value="">All Types</option>
                                    <option value="deposit">Deposits</option>
                                    <option value="withdrawal">Withdrawals</option>
                                </select>
                                <select id="txn-category-filter" style="padding: 0.5rem 1rem; border: 1px solid var(--gray-300); border-radius: var(--radius-md);" onchange="filterBankTransactions()">
                                    <option value="">All Categories</option>
                                </select>
                            </div>
                        </div>
                        <div class="table-container">
                            <table>
                                <thead>
                                    <tr>
                                        <th>Date</th>
                                        <th>Description</th>
                                        <th>Category</th>
                                        <th>Amount</th>
                                        <th>Balance</th>
                                        <th>Match</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="bank-transactions-table">
                                    <tr>
                                        <td colspan="7" class="text-center text-muted" style="padding: 3rem;">
                                            No bank transactions yet. Import a Chase CSV to get started.
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- Category Breakdown -->
                <div class="grid-2 mt-2">
                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title">Income by Category</h3>
                        </div>
                        <div class="card-body" id="income-breakdown">
                            <div class="empty-state">
                                <div class="empty-state-message">No income data yet</div>
                            </div>
                        </div>
                    </div>
                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title">Expenses by Category</h3>
                        </div>
                        <div class="card-body" id="expense-breakdown">
                            <div class="empty-state">
                                <div class="empty-state-message">No expense data yet</div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Stripe Payout Matching Section -->
                <div class="card mt-2">
                    <div class="card-header">
                        <h3 class="card-title">Stripe Payout Matching</h3>
                        <span class="badge badge-info" id="match-status">Pending</span>
                    </div>
                    <div class="table-container">
                        <table>
                            <thead>
                                <tr>
                                    <th>Stripe Payout Date</th>
                                    <th>Stripe Amount</th>
                                    <th>Chase Deposit Date</th>
                                    <th>Chase Amount</th>
                                    <th>Difference</th>
                                    <th>Status</th>
                                </tr>
                            </thead>
                            <tbody id="payout-match-table">
                                <tr>
                                    <td colspan="6" class="text-center text-muted" style="padding: 2rem;">
                                        Click "Match Stripe Payouts" to find matching deposits
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- ============================================
                 REPORTS TAB
                 ============================================ -->
            <div class="page-content" id="page-reports">
                <div class="page-header">
                    <div>
                        <h1 class="page-title">Reports</h1>
                        <p class="page-subtitle">Financial analytics and membership insights</p>
                    </div>
                    <div class="quick-actions">
                        <select id="report-period" style="padding: 0.5rem 1rem; border: 1px solid var(--gray-300); border-radius: var(--radius-md);" onchange="refreshReports()">
                            <option value="this_month">This Month</option>
                            <option value="last_month">Last Month</option>
                            <option value="this_quarter">This Quarter</option>
                            <option value="last_quarter">Last Quarter</option>
                            <option value="this_year" selected>This Year</option>
                            <option value="all_time">All Time</option>
                        </select>
                        <button class="btn btn-secondary" onclick="exportReportsToPDF()">Export PDF</button>
                    </div>
                </div>

                <!-- Key Metrics -->
                <div class="report-stat-grid">
                    <div class="report-stat-card">
                        <div class="report-stat-value positive" id="report-total-revenue">$0</div>
                        <div class="report-stat-label">Total Revenue</div>
                    </div>
                    <div class="report-stat-card">
                        <div class="report-stat-value" id="report-total-members">0</div>
                        <div class="report-stat-label">Active Members</div>
                    </div>
                    <div class="report-stat-card">
                        <div class="report-stat-value" id="report-avg-revenue">$0</div>
                        <div class="report-stat-label">Avg Revenue/Member</div>
                    </div>
                    <div class="report-stat-card">
                        <div class="report-stat-value" id="report-churn-rate">0%</div>
                        <div class="report-stat-label">Churn Rate</div>
                    </div>
                </div>

                <!-- Charts Grid -->
                <div class="reports-grid">
                    <!-- Monthly Revenue Chart -->
                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title">Monthly Revenue</h3>
                        </div>
                        <div class="chart-container">
                            <canvas id="revenue-chart"></canvas>
                        </div>
                    </div>

                    <!-- Member Growth Chart -->
                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title">Member Growth</h3>
                        </div>
                        <div class="chart-container">
                            <canvas id="members-chart"></canvas>
                        </div>
                    </div>

                    <!-- Revenue by Source -->
                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title">Revenue by Source</h3>
                        </div>
                        <div class="chart-container">
                            <canvas id="source-chart"></canvas>
                        </div>
                    </div>

                    <!-- Churn Analysis -->
                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title">Churn Analysis</h3>
                        </div>
                        <div class="card-body">
                            <div class="churn-metric">
                                <span class="churn-label">New Members (Period)</span>
                                <span class="churn-value positive" id="churn-new">0</span>
                            </div>
                            <div class="churn-metric">
                                <span class="churn-label">Canceled Members</span>
                                <span class="churn-value negative" id="churn-canceled">0</span>
                            </div>
                            <div class="churn-metric">
                                <span class="churn-label">Net Change</span>
                                <span class="churn-value" id="churn-net">0</span>
                            </div>
                            <div class="churn-metric">
                                <span class="churn-label">Retention Rate</span>
                                <span class="churn-value" id="churn-retention">0%</span>
                            </div>
                            <div class="churn-metric">
                                <span class="churn-label">Avg Member Lifetime</span>
                                <span class="churn-value" id="churn-lifetime">0 months</span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Top Members Table -->
                <div class="card mt-3">
                    <div class="card-header">
                        <h3 class="card-title">Top Members by Revenue</h3>
                    </div>
                    <div class="table-container">
                        <table>
                            <thead>
                                <tr>
                                    <th>Member</th>
                                    <th>Plan</th>
                                    <th>Total Paid</th>
                                    <th>Payments</th>
                                    <th>Since</th>
                                </tr>
                            </thead>
                            <tbody id="top-members-table">
                                <tr>
                                    <td colspan="5" class="text-center text-muted" style="padding: 2rem;">
                                        No data available
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- ============================================
                 SETTINGS TAB
                 ============================================ -->
            <div class="page-content" id="page-settings">
                <div class="page-header">
                    <div>
                        <h1 class="page-title">Settings</h1>
                        <p class="page-subtitle">Manage users, categories, and portal configuration</p>
                    </div>
                </div>

                <!-- User Management (Admin Only) -->
                <div class="settings-section" id="user-management-section">
                    <h3 class="settings-title">User Management</h3>
                    <div class="card">
                        <div class="card-body">
                            <div class="user-card">
                                <div class="user-card-info">
                                    <div class="user-card-avatar">EB</div>
                                    <div>
                                        <div class="user-card-name">Edmund Bogen</div>
                                        <div class="user-card-role">Admin</div>
                                    </div>
                                </div>
                                <button class="btn btn-sm btn-outline" onclick="openChangePasswordModal('edmund')">Change Password</button>
                            </div>
                            <div class="user-card">
                                <div class="user-card-info">
                                    <div class="user-card-avatar">EY</div>
                                    <div>
                                        <div class="user-card-name">Eytan</div>
                                        <div class="user-card-role">Full Admin</div>
                                    </div>
                                </div>
                                <button class="btn btn-sm btn-outline" onclick="openChangePasswordModal('eytan')">Change Password</button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Expense Categories -->
                <div class="settings-section">
                    <h3 class="settings-title">Expense Categories</h3>
                    <div class="card">
                        <div class="card-body">
                            <p class="text-muted mb-2">Manage expense categories for bookkeeping and vendor auto-categorization.</p>
                            <button class="btn btn-secondary btn-sm" onclick="openModal('manage-categories-modal')">Manage Categories</button>
                            <button class="btn btn-outline btn-sm" onclick="openModal('vendor-mappings-modal')" style="margin-left: 0.5rem;">Vendor Mappings</button>
                        </div>
                    </div>
                </div>

                <!-- Data Management -->
                <div class="settings-section">
                    <h3 class="settings-title">Data Management</h3>
                    <div class="card">
                        <div class="card-body">
                            <div class="grid-2">
                                <div>
                                    <h4 style="font-size: 0.875rem; margin-bottom: 0.5rem;">Export All Data</h4>
                                    <p class="text-muted mb-2" style="font-size: 0.875rem;">Download a complete backup of all portal data.</p>
                                    <button class="btn btn-secondary btn-sm" onclick="exportAllData()">Export JSON</button>
                                </div>
                                <div>
                                    <h4 style="font-size: 0.875rem; margin-bottom: 0.5rem;">Import Data</h4>
                                    <p class="text-muted mb-2" style="font-size: 0.875rem;">Restore from a previous backup.</p>
                                    <button class="btn btn-secondary btn-sm" onclick="openModal('import-backup-modal')">Import Backup</button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- ============================================
         MODALS
         ============================================ -->

    <!-- Change Password Modal -->
    <div class="modal-overlay" id="change-password-modal">
        <div class="modal">
            <div class="modal-header">
                <h3 class="modal-title">Change Password</h3>
                <button class="modal-close" onclick="closeModal('change-password-modal')">&times;</button>
            </div>
            <div class="modal-body">
                <p class="mb-2">Changing password for: <strong id="change-password-user">User</strong></p>
                <div class="form-group">
                    <label for="new-password">New Password</label>
                    <input type="password" id="new-password" placeholder="Enter new password">
                </div>
                <div class="form-group mb-0">
                    <label for="confirm-password">Confirm Password</label>
                    <input type="password" id="confirm-password" placeholder="Confirm new password">
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeModal('change-password-modal')">Cancel</button>
                <button class="btn btn-primary" onclick="savePassword()">Save Password</button>
            </div>
        </div>
    </div>

    <!-- Import Kajabi Modal -->
    <div class="modal-overlay" id="import-kajabi-modal">
        <div class="modal">
            <div class="modal-header">
                <h3 class="modal-title">Import Kajabi Subscriptions</h3>
                <button class="modal-close" onclick="closeModal('import-kajabi-modal')">&times;</button>
            </div>
            <div class="modal-body">
                <p class="mb-2">Upload your Kajabi <strong>subscriptions.csv</strong> export file.</p>
                <div class="form-group">
                    <label for="kajabi-file">CSV File</label>
                    <input type="file" id="kajabi-file" accept=".csv">
                </div>
                <div class="alert alert-info">
                    <div class="alert-icon">&#128161;</div>
                    <div class="alert-content">
                        <div class="alert-message">
                            <strong>How to export:</strong><br>
                            Kajabi â†’ Analytics â†’ Revenue â†’ Subscriptions â†’ Export<br><br>
                            <strong>Expected columns:</strong> Customer Email, Customer Name, Amount, Status, Offer Title
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeModal('import-kajabi-modal')">Cancel</button>
                <button class="btn btn-primary" onclick="importKajabiCSV()">Import</button>
            </div>
        </div>
    </div>

    <!-- Import Stripe 1 Modal -->
    <div class="modal-overlay" id="import-stripe1-modal">
        <div class="modal">
            <div class="modal-header">
                <h3 class="modal-title">Import Stripe: REIGNation</h3>
                <button class="modal-close" onclick="closeModal('import-stripe1-modal')">&times;</button>
            </div>
            <div class="modal-body">
                <p class="mb-2">Upload your Stripe payment export CSV from the REIGNation account.</p>
                <div class="form-group">
                    <label for="stripe1-file">CSV File</label>
                    <input type="file" id="stripe1-file" accept=".csv">
                </div>
                <div class="alert alert-info">
                    <div class="alert-icon">&#128161;</div>
                    <div class="alert-content">
                        <div class="alert-message">Export from Stripe: Payments â†’ Export</div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeModal('import-stripe1-modal')">Cancel</button>
                <button class="btn btn-primary" onclick="importStripeCSV('reignation')">Import</button>
            </div>
        </div>
    </div>

    <!-- Import Stripe 2 Modal -->
    <div class="modal-overlay" id="import-stripe2-modal">
        <div class="modal">
            <div class="modal-header">
                <h3 class="modal-title">Import Stripe: Coaching</h3>
                <button class="modal-close" onclick="closeModal('import-stripe2-modal')">&times;</button>
            </div>
            <div class="modal-body">
                <p class="mb-2">Upload your Stripe payment export CSV from the Coaching account.</p>
                <div class="form-group">
                    <label for="stripe2-file">CSV File</label>
                    <input type="file" id="stripe2-file" accept=".csv">
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeModal('import-stripe2-modal')">Cancel</button>
                <button class="btn btn-primary" onclick="importStripeCSV('coaching')">Import</button>
            </div>
        </div>
    </div>

    <!-- Import Chase CSV Modal -->
    <div class="modal-overlay" id="import-chase-modal">
        <div class="modal" style="max-width: 550px;">
            <div class="modal-header">
                <h3 class="modal-title">Import Chase Bank Statement</h3>
                <button class="modal-close" onclick="closeModal('import-chase-modal')">&times;</button>
            </div>
            <div class="modal-body">
                <p class="mb-2">Upload your Chase bank statement (CSV or PDF).</p>
                <div class="form-group">
                    <label for="chase-file">Statement File (CSV or PDF)</label>
                    <input type="file" id="chase-file" accept=".csv,.pdf">
                </div>
                <div class="form-group">
                    <label for="chase-account-name">Account Name (optional)</label>
                    <input type="text" id="chase-account-name" placeholder="e.g., Business Checking">
                </div>
                <div class="alert alert-info">
                    <div class="alert-icon">&#128161;</div>
                    <div class="alert-content">
                        <div class="alert-message">
                            <strong>Supported formats:</strong><br>
                            <strong>CSV:</strong> Chase.com â†’ Account Activity â†’ Download â†’ CSV<br>
                            <strong>PDF:</strong> Chase.com â†’ Statements â†’ Download Statement
                        </div>
                    </div>
                </div>
                <div class="form-group">
                    <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
                        <input type="checkbox" id="chase-auto-categorize" checked>
                        Auto-categorize transactions by vendor
                    </label>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeModal('import-chase-modal')">Cancel</button>
                <button class="btn btn-primary" onclick="importChaseFile()">Import</button>
            </div>
        </div>
    </div>

    <!-- Add Transaction Modal -->
    <div class="modal-overlay" id="add-transaction-modal">
        <div class="modal" style="max-width: 500px;">
            <div class="modal-header">
                <h3 class="modal-title">Add Transaction</h3>
                <button class="modal-close" onclick="closeModal('add-transaction-modal')">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label for="txn-date">Date</label>
                    <input type="date" id="txn-date">
                </div>
                <div class="form-group">
                    <label for="txn-description">Description</label>
                    <input type="text" id="txn-description" placeholder="e.g., Kajabi Monthly Subscription">
                </div>
                <div class="form-group">
                    <label for="txn-amount">Amount</label>
                    <input type="number" id="txn-amount" step="0.01" placeholder="0.00">
                </div>
                <div class="form-group">
                    <label for="txn-type">Type</label>
                    <select id="txn-type">
                        <option value="withdrawal">Expense (Withdrawal)</option>
                        <option value="deposit">Income (Deposit)</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="txn-new-category">Category</label>
                    <select id="txn-new-category">
                        <option value="">Select category...</option>
                    </select>
                </div>
                <div class="form-group mb-0">
                    <label for="txn-notes">Notes (optional)</label>
                    <input type="text" id="txn-notes" placeholder="Additional notes...">
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeModal('add-transaction-modal')">Cancel</button>
                <button class="btn btn-primary" onclick="addManualTransaction()">Add Transaction</button>
            </div>
        </div>
    </div>

    <!-- Edit Transaction Category Modal -->
    <div class="modal-overlay" id="edit-category-modal">
        <div class="modal" style="max-width: 450px;">
            <div class="modal-header">
                <h3 class="modal-title">Edit Category</h3>
                <button class="modal-close" onclick="closeModal('edit-category-modal')">&times;</button>
            </div>
            <div class="modal-body">
                <p class="mb-2">Transaction: <strong id="edit-cat-txn-desc">-</strong></p>
                <div class="form-group">
                    <label for="edit-cat-select">Category</label>
                    <select id="edit-cat-select">
                        <option value="">Select category...</option>
                    </select>
                </div>
                <div class="form-group mb-0">
                    <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
                        <input type="checkbox" id="edit-cat-remember">
                        Remember this category for similar transactions
                    </label>
                </div>
                <input type="hidden" id="edit-cat-txn-id">
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeModal('edit-category-modal')">Cancel</button>
                <button class="btn btn-primary" onclick="saveTransactionCategory()">Save</button>
            </div>
        </div>
    </div>

    <!-- Manage Categories Modal -->
    <div class="modal-overlay" id="manage-categories-modal">
        <div class="modal" style="max-width: 600px;">
            <div class="modal-header">
                <h3 class="modal-title">Manage Categories</h3>
                <button class="modal-close" onclick="closeModal('manage-categories-modal')">&times;</button>
            </div>
            <div class="modal-body" style="max-height: 400px; overflow-y: auto;">
                <div id="categories-list">
                    <!-- Populated by JS -->
                </div>
                <div style="margin-top: 1rem; padding-top: 1rem; border-top: 1px solid var(--gray-200);">
                    <h4 style="font-size: 0.875rem; margin-bottom: 0.75rem;">Add New Category</h4>
                    <div style="display: flex; gap: 0.5rem; flex-wrap: wrap;">
                        <input type="text" id="new-cat-name" placeholder="Category name" style="flex: 1; min-width: 150px; padding: 0.5rem;">
                        <select id="new-cat-type" style="padding: 0.5rem;">
                            <option value="expense">Expense</option>
                            <option value="income">Income</option>
                        </select>
                        <input type="color" id="new-cat-color" value="#6b7280" style="width: 40px; height: 36px; padding: 2px;">
                        <button class="btn btn-primary btn-sm" onclick="addCategory()">Add</button>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeModal('manage-categories-modal')">Close</button>
            </div>
        </div>
    </div>

    <!-- Vendor Mappings Modal -->
    <div class="modal-overlay" id="vendor-mappings-modal">
        <div class="modal" style="max-width: 650px;">
            <div class="modal-header">
                <h3 class="modal-title">Vendor Auto-Categorization</h3>
                <button class="modal-close" onclick="closeModal('vendor-mappings-modal')">&times;</button>
            </div>
            <div class="modal-body" style="max-height: 400px; overflow-y: auto;">
                <p class="text-muted mb-2">When a transaction description contains these keywords, it will be auto-categorized.</p>
                <div id="vendor-mappings-list" style="margin-top: 1rem;">
                    <!-- Populated by JS -->
                </div>
                <div style="margin-top: 1rem; padding-top: 1rem; border-top: 1px solid var(--gray-200);">
                    <h4 style="font-size: 0.875rem; margin-bottom: 0.75rem;">Add New Mapping</h4>
                    <div style="display: flex; gap: 0.5rem; flex-wrap: wrap;">
                        <input type="text" id="new-vendor-keyword" placeholder="Keyword (e.g., netflix)" style="flex: 1; min-width: 120px; padding: 0.5rem;">
                        <select id="new-vendor-category" style="flex: 1; min-width: 150px; padding: 0.5rem;">
                            <option value="">Select category...</option>
                        </select>
                        <button class="btn btn-primary btn-sm" onclick="addVendorMapping()">Add</button>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-outline" onclick="resetVendorMappings()">Reset to Defaults</button>
                <button class="btn btn-secondary" onclick="closeModal('vendor-mappings-modal')">Close</button>
            </div>
        </div>
    </div>

    <!-- Member Details Modal (Phase 2) -->
    <div class="modal-overlay" id="member-details-modal">
        <div class="modal" style="max-width: 800px;">
            <div class="modal-header">
                <h3 class="modal-title">Member Details</h3>
                <button class="modal-close" onclick="closeModal('member-details-modal')">&times;</button>
            </div>
            <div class="modal-body" style="max-height: 600px; overflow-y: auto;">
                <!-- Member Info Header -->
                <div style="display: flex; align-items: center; gap: 1rem; margin-bottom: 1.5rem; padding-bottom: 1rem; border-bottom: 1px solid var(--gray-200);">
                    <div id="member-detail-avatar" style="width: 60px; height: 60px; border-radius: 50%; background: var(--brand-primary); display: flex; align-items: center; justify-content: center; font-size: 1.5rem; font-weight: 600; color: white;">--</div>
                    <div style="flex: 1;">
                        <h2 id="member-detail-name" style="font-size: 1.25rem; margin: 0; color: var(--navy);">Member Name</h2>
                        <p id="member-detail-email" style="margin: 0.25rem 0 0; color: var(--gray-500); font-size: 0.875rem;">email@example.com</p>
                    </div>
                    <div id="member-detail-status-badge">
                        <span class="badge badge-success">Active</span>
                    </div>
                </div>

                <!-- Stats Cards -->
                <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 1rem; margin-bottom: 1.5rem;">
                    <div style="background: var(--gray-50); padding: 1rem; border-radius: var(--radius-md); text-align: center;">
                        <div style="font-size: 0.7rem; color: var(--gray-500); text-transform: uppercase; letter-spacing: 0.05em;">Monthly Rate</div>
                        <div id="member-detail-rate" style="font-size: 1.5rem; font-weight: 600; color: var(--navy);">$0</div>
                    </div>
                    <div style="background: var(--gray-50); padding: 1rem; border-radius: var(--radius-md); text-align: center;">
                        <div style="font-size: 0.7rem; color: var(--gray-500); text-transform: uppercase; letter-spacing: 0.05em;">Total Paid</div>
                        <div id="member-detail-total" style="font-size: 1.5rem; font-weight: 600; color: var(--success);">$0</div>
                    </div>
                    <div style="background: var(--gray-50); padding: 1rem; border-radius: var(--radius-md); text-align: center;">
                        <div style="font-size: 0.7rem; color: var(--gray-500); text-transform: uppercase; letter-spacing: 0.05em;">Member Since</div>
                        <div id="member-detail-since" style="font-size: 1rem; font-weight: 600; color: var(--navy);">--</div>
                    </div>
                </div>

                <!-- Subscription Details -->
                <div style="margin-bottom: 1.5rem;">
                    <h4 style="font-size: 0.875rem; text-transform: uppercase; letter-spacing: 0.05em; color: var(--gray-600); margin-bottom: 0.75rem;">Subscription Details</h4>
                    <div style="background: var(--white); border: 1px solid var(--gray-200); border-radius: var(--radius-md); padding: 1rem;">
                        <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 1rem;">
                            <div>
                                <div style="font-size: 0.75rem; color: var(--gray-500);">Plan</div>
                                <div id="member-detail-plan" style="font-weight: 500;">--</div>
                            </div>
                            <div>
                                <div style="font-size: 0.75rem; color: var(--gray-500);">Billing Frequency</div>
                                <div id="member-detail-frequency" style="font-weight: 500;">--</div>
                            </div>
                            <div>
                                <div style="font-size: 0.75rem; color: var(--gray-500);">Last Payment</div>
                                <div id="member-detail-last-payment" style="font-weight: 500;">--</div>
                            </div>
                            <div>
                                <div style="font-size: 0.75rem; color: var(--gray-500);">Kajabi ID</div>
                                <div id="member-detail-kajabi-id" style="font-weight: 500; font-family: monospace; font-size: 0.875rem;">--</div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Payment History -->
                <div>
                    <h4 style="font-size: 0.875rem; text-transform: uppercase; letter-spacing: 0.05em; color: var(--gray-600); margin-bottom: 0.75rem;">Payment History</h4>
                    <div style="background: var(--white); border: 1px solid var(--gray-200); border-radius: var(--radius-md); overflow: hidden;">
                        <table class="data-table" style="margin: 0;">
                            <thead>
                                <tr>
                                    <th>Date</th>
                                    <th>Amount</th>
                                    <th>Status</th>
                                    <th>Account</th>
                                </tr>
                            </thead>
                            <tbody id="member-detail-payments">
                                <tr>
                                    <td colspan="4" class="text-center text-muted" style="padding: 2rem;">No payment history found</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Notes Section -->
                <div style="margin-top: 1.5rem;">
                    <h4 style="font-size: 0.875rem; text-transform: uppercase; letter-spacing: 0.05em; color: var(--gray-600); margin-bottom: 0.75rem;">Notes</h4>
                    <textarea id="member-detail-notes" style="width: 100%; min-height: 80px; padding: 0.75rem; border: 1px solid var(--gray-300); border-radius: var(--radius-md); font-family: inherit; resize: vertical;" placeholder="Add notes about this member..."></textarea>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeModal('member-details-modal')">Close</button>
                <button class="btn btn-primary" onclick="saveMemberNotes()">Save Notes</button>
            </div>
        </div>
    </div>

    <!-- ============================================
         JAVASCRIPT
         ============================================ -->
    <script>
        // ============================================
        // CONFIGURATION
        // ============================================

        // Supabase Configuration
        const SUPABASE_URL = 'https://tnnymwtjcfedprfqwprd.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InRubnltd3RqY2ZlZHByZnF3cHJkIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njk0ODYyMDIsImV4cCI6MjA4NTA2MjIwMn0.yTx0dVJ3NuBBCSQzM_QR2-vNUP-Y9iXHlgSyiGSmQgo';

        // Initialize Supabase client
        let supabaseClient = null;
        let syncStatus = 'offline';

        // User profiles (keyed by email - no passwords stored in code)
        const userProfiles = {
            'edmund@edmundbogen.com': {
                name: 'Edmund Bogen',
                role: 'admin',
                initials: 'EB'
            },
            'eytan@bogen.ai': {
                name: 'Eytan',
                role: 'full_admin',
                initials: 'EY'
            }
        };

        // Current user session
        let currentUser = null;

        // App data (localStorage with Supabase sync)
        let appData = {
            members: [],
            stripeTransactions: [],
            discrepancies: [],
            importLogs: [],
            settings: {},
            // Bookkeeping data
            bankTransactions: [],
            bankStatements: [],
            expenseCategories: getDefaultCategories(),
            vendorMappings: getDefaultVendorMappings(),
            stripePayoutMatches: []
        };

        // Default expense categories
        function getDefaultCategories() {
            return [
                { id: 'cat_income_mastermind', name: 'Mastermind Subscriptions', type: 'income', color: '#059669' },
                { id: 'cat_income_coaching', name: 'Coaching Revenue', type: 'income', color: '#10b981' },
                { id: 'cat_income_speaking', name: 'Speaking Fees', type: 'income', color: '#34d399' },
                { id: 'cat_income_affiliate', name: 'Affiliate Income', type: 'income', color: '#6ee7b7' },
                { id: 'cat_income_stripe', name: 'Stripe Payout', type: 'income', color: '#635bff' },
                { id: 'cat_income_other', name: 'Other Income', type: 'income', color: '#a7f3d0' },
                { id: 'cat_exp_kajabi', name: 'Kajabi Platform', type: 'expense', color: '#dc2626' },
                { id: 'cat_exp_ai', name: 'AI Tools', type: 'expense', color: '#ef4444' },
                { id: 'cat_exp_software', name: 'Software Subscriptions', type: 'expense', color: '#f87171' },
                { id: 'cat_exp_contractors', name: 'Contractors/VA', type: 'expense', color: '#fca5a5' },
                { id: 'cat_exp_marketing', name: 'Marketing', type: 'expense', color: '#d97706' },
                { id: 'cat_exp_travel', name: 'Travel', type: 'expense', color: '#f59e0b' },
                { id: 'cat_exp_professional', name: 'Professional Services', type: 'expense', color: '#fbbf24' },
                { id: 'cat_exp_office', name: 'Office Equipment', type: 'expense', color: '#fcd34d' },
                { id: 'cat_exp_bank_fees', name: 'Bank Fees', type: 'expense', color: '#6b7280' },
                { id: 'cat_exp_refunds', name: 'Refunds', type: 'expense', color: '#9ca3af' },
                { id: 'cat_exp_meals', name: 'Meals & Entertainment', type: 'expense', color: '#8b5cf6' },
                { id: 'cat_exp_education', name: 'Education', type: 'expense', color: '#a78bfa' },
                { id: 'cat_exp_insurance', name: 'Insurance', type: 'expense', color: '#c4b5fd' },
                { id: 'cat_uncategorized', name: 'Uncategorized', type: 'expense', color: '#94a3b8' }
            ];
        }

        // Default vendor to category mappings
        function getDefaultVendorMappings() {
            return {
                // Stripe payouts
                'stripe': 'cat_income_stripe',
                'stripe payments': 'cat_income_stripe',
                // Platform costs
                'kajabi': 'cat_exp_kajabi',
                'kajabi llc': 'cat_exp_kajabi',
                // AI Tools
                'openai': 'cat_exp_ai',
                'anthropic': 'cat_exp_ai',
                'claude': 'cat_exp_ai',
                'chatgpt': 'cat_exp_ai',
                'midjourney': 'cat_exp_ai',
                // Software
                'zoom': 'cat_exp_software',
                'zapier': 'cat_exp_software',
                'canva': 'cat_exp_software',
                'adobe': 'cat_exp_software',
                'google': 'cat_exp_software',
                'microsoft': 'cat_exp_software',
                'dropbox': 'cat_exp_software',
                'slack': 'cat_exp_software',
                'notion': 'cat_exp_software',
                'calendly': 'cat_exp_software',
                'typeform': 'cat_exp_software',
                'mailchimp': 'cat_exp_software',
                'convertkit': 'cat_exp_software',
                'activecampaign': 'cat_exp_software',
                // Marketing
                'facebook': 'cat_exp_marketing',
                'meta': 'cat_exp_marketing',
                'instagram': 'cat_exp_marketing',
                'linkedin': 'cat_exp_marketing',
                'google ads': 'cat_exp_marketing',
                // Travel
                'american airlines': 'cat_exp_travel',
                'delta': 'cat_exp_travel',
                'united': 'cat_exp_travel',
                'southwest': 'cat_exp_travel',
                'uber': 'cat_exp_travel',
                'lyft': 'cat_exp_travel',
                'marriott': 'cat_exp_travel',
                'hilton': 'cat_exp_travel',
                'airbnb': 'cat_exp_travel',
                // Professional Services
                'quickbooks': 'cat_exp_professional',
                'intuit': 'cat_exp_professional',
                // Bank Fees
                'chase fee': 'cat_exp_bank_fees',
                'service charge': 'cat_exp_bank_fees',
                'wire fee': 'cat_exp_bank_fees',
                'atm fee': 'cat_exp_bank_fees',
                // Refunds
                'refund': 'cat_exp_refunds',
                'chargeback': 'cat_exp_refunds'
            };
        }

        // Storage keys
        const STORAGE_KEYS = {
            SESSION: 'mastermind_billing_session',
            USERS: 'mastermind_billing_users',
            DATA: 'mastermind_billing_data'
        };

        // ============================================
        // INITIALIZATION
        // ============================================

        document.addEventListener('DOMContentLoaded', async function() {
            loadFromLocalStorage();
            setupEventListeners();
            await initSupabase();
            await checkAuth();
            // Refresh data display after auth
            if (currentUser) {
                refreshDashboard();
            }
        });

        async function initSupabase() {
            if (SUPABASE_URL !== 'YOUR_SUPABASE_URL' &&
                typeof window !== 'undefined' &&
                window.supabase &&
                window.supabase.createClient) {
                try {
                    supabaseClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
                    syncStatus = 'online';
                    syncManager.isOnline = true;
                    updateSyncStatus();
                    console.log('Supabase connected');

                    // Setup realtime subscriptions for conflict detection
                    await setupRealtimeSubscriptions();

                    // Replay any pending offline operations
                    await replaySyncQueue();

                    // Initial sync from cloud
                    await fullSync();
                } catch (e) {
                    console.warn('Supabase initialization failed:', e);
                    syncStatus = 'offline';
                    syncManager.isOnline = false;
                    updateSyncStatus();
                }
            } else {
                syncStatus = 'offline';
                syncManager.isOnline = false;
                updateSyncStatus();
                console.log('Running in offline mode (localStorage only)');
            }
        }

        function updateSyncStatus(status) {
            if (status) syncStatus = status;

            const dot = document.getElementById('sync-dot');
            const text = document.getElementById('sync-text');

            if (!dot || !text) return;

            // Get pending sync counts
            const pendingCounts = getPendingSyncCount();
            const hasPending = pendingCounts.pending > 0 || pendingCounts.failed > 0 || pendingCounts.conflicts > 0;

            if (syncStatus === 'syncing') {
                dot.className = 'sync-dot syncing';
                text.textContent = 'Syncing...';
            } else if (syncStatus === 'online') {
                dot.className = 'sync-dot';
                if (hasPending) {
                    if (pendingCounts.conflicts > 0) {
                        text.textContent = `${pendingCounts.conflicts} conflict(s)`;
                        dot.className = 'sync-dot error';
                    } else if (pendingCounts.failed > 0) {
                        text.textContent = `${pendingCounts.failed} failed`;
                        dot.className = 'sync-dot error';
                    } else {
                        text.textContent = `${pendingCounts.pending} pending`;
                        dot.className = 'sync-dot offline';
                    }
                } else {
                    text.textContent = 'Synced';
                }
            } else if (syncStatus === 'offline') {
                dot.className = 'sync-dot offline';
                if (pendingCounts.pending > 0) {
                    text.textContent = `Offline (${pendingCounts.pending} queued)`;
                } else {
                    text.textContent = 'Offline';
                }
            } else {
                dot.className = 'sync-dot error';
                if (pendingCounts.conflicts > 0) {
                    text.textContent = `${pendingCounts.conflicts} conflict(s)`;
                } else if (pendingCounts.failed > 0) {
                    text.textContent = `${pendingCounts.failed} failed`;
                } else {
                    text.textContent = 'Error';
                }
            }
        }

        function loadFromLocalStorage() {
            // Load app data
            const storedData = localStorage.getItem(STORAGE_KEYS.DATA);
            if (storedData) {
                try {
                    const parsed = JSON.parse(storedData);

                    // Deep sanitization to protect against prototype pollution
                    // Recursively sanitizes objects and arrays
                    const DANGEROUS_KEYS = new Set(['__proto__', 'constructor', 'prototype']);
                    const MAX_DEPTH = 10; // Prevent stack overflow on circular refs

                    const deepSanitize = (value, depth = 0) => {
                        if (depth > MAX_DEPTH) return null;
                        if (value === null || value === undefined) return value;
                        if (typeof value !== 'object') return value;

                        if (Array.isArray(value)) {
                            return value
                                .filter(item => item !== null && typeof item === 'object' ?
                                    !DANGEROUS_KEYS.has(Object.keys(item)[0]) : true)
                                .map(item => deepSanitize(item, depth + 1));
                        }

                        const safe = Object.create(null);
                        for (const key of Object.keys(value)) {
                            if (DANGEROUS_KEYS.has(key)) continue;
                            safe[key] = deepSanitize(value[key], depth + 1);
                        }
                        return safe;
                    };

                    const safeArray = (arr) => {
                        if (!Array.isArray(arr)) return [];
                        return deepSanitize(arr);
                    };

                    const safeObject = (obj) => {
                        if (!obj || typeof obj !== 'object' || Array.isArray(obj)) return {};
                        return deepSanitize(obj);
                    };

                    // Build appData with validated fields only
                    appData = {
                        members: safeArray(parsed.members),
                        stripeTransactions: safeArray(parsed.stripeTransactions),
                        discrepancies: safeArray(parsed.discrepancies),
                        importLogs: safeArray(parsed.importLogs),
                        settings: safeObject(parsed.settings),
                        // Bookkeeping data - use stored or defaults
                        bankTransactions: safeArray(parsed.bankTransactions),
                        bankStatements: safeArray(parsed.bankStatements),
                        expenseCategories: safeArray(parsed.expenseCategories).length > 0
                            ? safeArray(parsed.expenseCategories)
                            : getDefaultCategories(),
                        vendorMappings: Object.keys(safeObject(parsed.vendorMappings)).length > 0
                            ? safeObject(parsed.vendorMappings)
                            : getDefaultVendorMappings(),
                        stripePayoutMatches: safeArray(parsed.stripePayoutMatches),
                        // Sync queue for offline changes
                        syncQueue: safeArray(parsed.syncQueue) || [],
                        // Per-record sync status
                        syncStatus: safeObject(parsed.syncStatus) || {}
                    };
                } catch (e) {
                    console.error('Error loading data from localStorage:', e);
                    // Keep defaults on parse error
                }
            }

            // Ensure sync structures exist
            if (!appData.syncQueue) appData.syncQueue = [];
            if (!appData.syncStatus) appData.syncStatus = {};
        }

        // localStorage size monitoring
        const storageMonitor = {
            WARNING_THRESHOLD: 4 * 1024 * 1024, // 4MB warning
            CRITICAL_THRESHOLD: 4.5 * 1024 * 1024, // 4.5MB critical
            lastWarningTime: 0,
            WARNING_COOLDOWN: 300000, // Only warn every 5 minutes

            getUsedSpace() {
                let total = 0;
                for (const key in localStorage) {
                    if (localStorage.hasOwnProperty(key)) {
                        total += localStorage.getItem(key).length * 2; // UTF-16 = 2 bytes per char
                    }
                }
                return total;
            },

            checkAndWarn() {
                const used = this.getUsedSpace();
                const now = Date.now();

                if (used > this.CRITICAL_THRESHOLD) {
                    console.error(`localStorage critically full: ${(used / 1024 / 1024).toFixed(2)}MB`);
                    if (now - this.lastWarningTime > this.WARNING_COOLDOWN) {
                        this.lastWarningTime = now;
                        updateSyncStatus('error');
                        alert('Storage is almost full! Please export your data and clear old records to prevent data loss.');
                    }
                    return false;
                } else if (used > this.WARNING_THRESHOLD) {
                    console.warn(`localStorage usage high: ${(used / 1024 / 1024).toFixed(2)}MB`);
                    if (now - this.lastWarningTime > this.WARNING_COOLDOWN) {
                        this.lastWarningTime = now;
                    }
                }
                return true;
            },

            pruneOldData() {
                // Prune import logs older than 90 days
                const ninetyDaysAgo = Date.now() - (90 * 24 * 60 * 60 * 1000);
                const originalLogCount = appData.importLogs?.length || 0;
                appData.importLogs = (appData.importLogs || []).filter(log => {
                    const logDate = new Date(log.imported_at || log.date || 0).getTime();
                    return logDate > ninetyDaysAgo;
                });

                // Prune resolved discrepancies older than 30 days
                const thirtyDaysAgo = Date.now() - (30 * 24 * 60 * 60 * 1000);
                const originalDiscCount = appData.discrepancies?.length || 0;
                appData.discrepancies = (appData.discrepancies || []).filter(d => {
                    if (d.status !== 'resolved') return true;
                    const resolvedDate = new Date(d.resolved_at || 0).getTime();
                    return resolvedDate > thirtyDaysAgo;
                });

                const pruned = (originalLogCount - appData.importLogs.length) +
                              (originalDiscCount - appData.discrepancies.length);
                if (pruned > 0) {
                    console.log(`Pruned ${pruned} old records to save space`);
                }
                return pruned;
            }
        };

        function saveToLocalStorage(pushToCloud = false) {
            // Check storage before saving
            if (!storageMonitor.checkAndWarn()) {
                // Try to prune old data if critically full
                storageMonitor.pruneOldData();
            }

            try {
                // User auth is handled by Supabase Auth - only save app data
                localStorage.setItem(STORAGE_KEYS.DATA, JSON.stringify(appData));
            } catch (e) {
                if (e.name === 'QuotaExceededError') {
                    console.error('localStorage quota exceeded');
                    // Try pruning and retry
                    storageMonitor.pruneOldData();
                    try {
                        localStorage.setItem(STORAGE_KEYS.DATA, JSON.stringify(appData));
                    } catch (retryError) {
                        alert('Storage full! Please export your data immediately. Some data may not be saved.');
                        updateSyncStatus('error');
                    }
                } else {
                    throw e;
                }
            }

            // Only sync to cloud when explicitly requested (after CSV imports)
            if (pushToCloud) {
                if (supabaseClient && syncManager.isOnline) {
                    syncToSupabase();
                } else {
                    // Queue the sync for when we're back online
                    console.log('Offline - changes saved locally and queued for sync');
                    updateSyncStatus('offline');
                }
            }
        }

        // Helper to track and queue a specific record change
        function trackRecordChange(table, data, operation = 'upsert') {
            if (!syncManager.isOnline) {
                // Queue for later sync
                queueSyncOperation({ type: operation, table, data });
            }

            // Update per-record sync status
            const recordKey = `${table}:${data.id || data.email}`;
            if (!appData.syncStatus) appData.syncStatus = {};
            appData.syncStatus[recordKey] = {
                status: syncManager.isOnline ? 'pending' : 'queued',
                lastModified: new Date().toISOString()
            };
        }

        // ============================================
        // ADVANCED SYNC SYSTEM
        // ============================================

        // Sync state management
        const syncManager = {
            // Promise-based lock to prevent race conditions
            _syncLock: null,
            _lockQueue: [],
            lastSyncTime: null,
            isOnline: navigator.onLine,
            realtimeSubscriptions: [],

            // Acquire sync lock with queuing
            async acquireLock() {
                if (this._syncLock) {
                    // Wait for existing lock to release
                    return new Promise((resolve) => {
                        this._lockQueue.push(resolve);
                    });
                }
                this._syncLock = true;
                return Promise.resolve();
            },

            // Release sync lock
            releaseLock() {
                this._syncLock = null;
                if (this._lockQueue.length > 0) {
                    const next = this._lockQueue.shift();
                    this._syncLock = true;
                    next();
                }
            },

            // Check if we can sync
            canSync() {
                return supabaseClient && this.isOnline && !this._syncLock;
            }
        };

        // Initialize online/offline detection
        window.addEventListener('online', async () => {
            syncManager.isOnline = true;
            updateSyncStatus('syncing');
            console.log('Back online - replaying sync queue');
            await replaySyncQueue();
        });

        window.addEventListener('offline', () => {
            syncManager.isOnline = false;
            updateSyncStatus('offline');
            console.log('Gone offline - changes will be queued');
        });

        // ============================================
        // SYNC QUEUE FOR OFFLINE CHANGES
        // ============================================

        function queueSyncOperation(operation) {
            if (!appData.syncQueue) appData.syncQueue = [];

            const queueItem = {
                id: generateId(),
                operation: operation.type, // 'upsert', 'delete'
                table: operation.table,
                data: operation.data,
                timestamp: new Date().toISOString(),
                retryCount: 0,
                status: 'pending' // 'pending', 'syncing', 'failed', 'completed'
            };

            appData.syncQueue.push(queueItem);

            // Update per-record sync status
            const recordKey = `${operation.table}:${operation.data.id || operation.data.email}`;
            if (!appData.syncStatus) appData.syncStatus = {};
            appData.syncStatus[recordKey] = {
                status: 'pending',
                lastAttempt: null,
                queueId: queueItem.id
            };

            // Save queue to localStorage
            try {
                localStorage.setItem(STORAGE_KEYS.DATA, JSON.stringify(appData));
            } catch (e) {
                console.error('Failed to save sync queue:', e);
            }

            return queueItem.id;
        }

        async function replaySyncQueue() {
            if (!supabaseClient || !syncManager.isOnline) return;
            if (!appData.syncQueue || appData.syncQueue.length === 0) {
                updateSyncStatus('online');
                return;
            }

            await syncManager.acquireLock();
            updateSyncStatus('syncing');

            try {
                const pendingItems = appData.syncQueue.filter(item =>
                    item.status === 'pending' || item.status === 'failed'
                );

                console.log(`Replaying ${pendingItems.length} queued sync operations`);

                for (const item of pendingItems) {
                    item.status = 'syncing';
                    item.retryCount++;

                    try {
                        if (item.operation === 'upsert') {
                            const { error } = await supabaseClient
                                .from(item.table)
                                .upsert(item.data, { onConflict: item.data.id ? 'id' : 'email' });

                            if (error) throw error;
                        } else if (item.operation === 'delete') {
                            const { error } = await supabaseClient
                                .from(item.table)
                                .delete()
                                .eq('id', item.data.id);

                            if (error) throw error;
                        }

                        item.status = 'completed';

                        // Update per-record status
                        const recordKey = `${item.table}:${item.data.id || item.data.email}`;
                        if (appData.syncStatus[recordKey]) {
                            appData.syncStatus[recordKey].status = 'synced';
                            appData.syncStatus[recordKey].lastSync = new Date().toISOString();
                        }

                    } catch (error) {
                        console.warn(`Sync failed for ${item.table}:`, error);
                        item.status = item.retryCount >= 3 ? 'failed' : 'pending';

                        const recordKey = `${item.table}:${item.data.id || item.data.email}`;
                        if (appData.syncStatus[recordKey]) {
                            appData.syncStatus[recordKey].status = 'failed';
                            appData.syncStatus[recordKey].lastError = error.message;
                        }
                    }
                }

                // Clean up completed items older than 1 hour
                const oneHourAgo = Date.now() - 3600000;
                appData.syncQueue = appData.syncQueue.filter(item =>
                    item.status !== 'completed' ||
                    new Date(item.timestamp).getTime() > oneHourAgo
                );

                saveToLocalStorage(false); // Don't trigger another sync

                const failedCount = appData.syncQueue.filter(i => i.status === 'failed').length;
                if (failedCount > 0) {
                    updateSyncStatus('error');
                } else {
                    updateSyncStatus('online');
                }

            } finally {
                syncManager.releaseLock();
            }
        }

        // ============================================
        // TIMESTAMP-BASED MERGE LOGIC
        // ============================================

        function mergeRecords(localRecord, remoteRecord, conflictStrategy = 'remote-wins') {
            if (!localRecord) return { merged: remoteRecord, hadConflict: false };
            if (!remoteRecord) return { merged: localRecord, hadConflict: false };

            const localTime = new Date(localRecord.updated_at || localRecord.createdAt || 0).getTime();
            const remoteTime = new Date(remoteRecord.updated_at || remoteRecord.created_at || 0).getTime();

            // Check for conflict (both modified since last sync)
            const lastSyncTime = syncManager.lastSyncTime ? syncManager.lastSyncTime.getTime() : 0;
            const hadConflict = localTime > lastSyncTime && remoteTime > lastSyncTime;

            if (hadConflict) {
                console.warn('Merge conflict detected:', {
                    id: localRecord.id || localRecord.email,
                    localTime: new Date(localTime).toISOString(),
                    remoteTime: new Date(remoteTime).toISOString()
                });
            }

            let merged;
            switch (conflictStrategy) {
                case 'local-wins':
                    merged = localTime >= remoteTime ? localRecord : remoteRecord;
                    break;
                case 'remote-wins':
                default:
                    merged = remoteTime >= localTime ? remoteRecord : localRecord;
                    break;
                case 'merge-fields':
                    // Merge individual fields, preferring newer values
                    merged = { ...localRecord };
                    for (const key of Object.keys(remoteRecord)) {
                        if (key === 'updated_at' || key === 'created_at') continue;
                        // If remote has a value and local doesn't, or remote is newer
                        if (remoteRecord[key] !== null && remoteRecord[key] !== undefined) {
                            if (localRecord[key] === null || localRecord[key] === undefined || remoteTime > localTime) {
                                merged[key] = remoteRecord[key];
                            }
                        }
                    }
                    merged.updated_at = new Date().toISOString();
                    break;
            }

            return { merged, hadConflict };
        }

        function mergeArrays(localArray, remoteArray, keyField = 'id') {
            const merged = [];
            const conflicts = [];
            const localMap = new Map(localArray.map(item => [item[keyField] || item.email, item]));
            const remoteMap = new Map(remoteArray.map(item => [item[keyField] || item.email, item]));
            const allKeys = new Set([...localMap.keys(), ...remoteMap.keys()]);

            for (const key of allKeys) {
                const local = localMap.get(key);
                const remote = remoteMap.get(key);
                const { merged: mergedRecord, hadConflict } = mergeRecords(local, remote);

                merged.push(mergedRecord);
                if (hadConflict) {
                    conflicts.push({ key, local, remote, resolved: mergedRecord });
                }
            }

            return { merged, conflicts };
        }

        // ============================================
        // BATCHED SYNC OPERATIONS
        // ============================================

        async function batchUpsert(table, records, conflictField = 'id') {
            if (!records || records.length === 0) return { success: true, errors: [] };

            const BATCH_SIZE = 100;
            const errors = [];

            for (let i = 0; i < records.length; i += BATCH_SIZE) {
                const batch = records.slice(i, i + BATCH_SIZE);

                try {
                    const { error } = await supabaseClient
                        .from(table)
                        .upsert(batch, { onConflict: conflictField });

                    if (error) {
                        console.warn(`Batch upsert error for ${table}:`, error);
                        errors.push({ batch: i / BATCH_SIZE, error: error.message });
                    }
                } catch (e) {
                    errors.push({ batch: i / BATCH_SIZE, error: e.message });
                }
            }

            return { success: errors.length === 0, errors };
        }

        // ============================================
        // MAIN SYNC FUNCTIONS
        // ============================================

        async function syncToSupabase() {
            if (!syncManager.canSync()) {
                // Queue operations for later if offline
                if (!syncManager.isOnline) {
                    console.log('Offline - queuing sync operations');
                    return;
                }
                // Wait for lock if another sync is in progress
                await syncManager.acquireLock();
            } else {
                await syncManager.acquireLock();
            }

            updateSyncStatus('syncing');

            try {
                const now = new Date().toISOString();

                // Prepare member data with updated_at
                const memberData = (appData.members || []).map(member => ({
                    email: member.email,
                    name: member.name || member.fullName || 'Unknown',
                    kajabi_id: member.kajabiId || member.kajabi_id || null,
                    subscription_plan: member.plan || member.subscription_plan || member.offerName || null,
                    subscription_amount: parseFloat(member.amount || member.subscription_amount) || 0,
                    billing_frequency: member.billingFrequency || member.billing_frequency || 'monthly',
                    subscription_status: member.status || member.subscription_status || 'active',
                    join_date: member.joinDate || member.join_date || member.createdAt || null,
                    last_payment_date: member.lastPaymentDate || member.last_payment_date || null,
                    total_paid: parseFloat(member.totalPaid || member.total_paid) || 0,
                    notes: member.notes || null,
                    updated_at: now
                }));

                // Batch upsert members
                if (memberData.length > 0) {
                    const { errors } = await batchUpsert('members', memberData, 'email');
                    if (errors.length > 0) console.warn('Member sync errors:', errors);
                }

                // Prepare stripe transactions
                const txnData = (appData.stripeTransactions || []).map(txn => ({
                    stripe_id: txn.id || txn.stripeId || txn.stripe_id || `local_${generateId()}`,
                    stripe_account: txn.account || txn.stripeAccount || txn.stripe_account || 'reignation',
                    member_email: txn.member_email || txn.email || txn.customerEmail || null,
                    customer_name: txn.customer_name || txn.name || txn.customerName || null,
                    amount: parseFloat(txn.amount) || 0,
                    fee: parseFloat(txn.fee) || 0,
                    net_amount: parseFloat(txn.netAmount || txn.net_amount) || 0,
                    status: txn.status || 'succeeded',
                    transaction_date: txn.date || txn.transaction_date || txn.created || now,
                    description: txn.description || null,
                    product_name: txn.productName || txn.product_name || null
                }));

                if (txnData.length > 0) {
                    const { errors } = await batchUpsert('stripe_transactions', txnData, 'stripe_id');
                    if (errors.length > 0) console.warn('Transaction sync errors:', errors);
                }

                // Prepare discrepancies
                const discData = (appData.discrepancies || []).map(disc => ({
                    id: disc.id,
                    member_email: disc.member_email || disc.email || disc.memberEmail || null,
                    member_name: disc.member_name || disc.name || disc.memberName || null,
                    discrepancy_type: disc.discrepancy_type || disc.type || disc.discrepancyType || 'amount_mismatch',
                    expected_amount: parseFloat(disc.expected_amount || disc.expectedAmount) || null,
                    actual_amount: parseFloat(disc.actual_amount || disc.actualAmount) || null,
                    difference: parseFloat(disc.difference) || null,
                    stripe_account: disc.stripe_account || disc.stripeAccount || null,
                    status: disc.status || 'open',
                    priority: disc.priority || 'medium',
                    resolution_notes: disc.resolution_notes || disc.notes || disc.resolutionNotes || null,
                    resolved_at: disc.resolved_at || null,
                    resolved_by: disc.resolved_by || null,
                    created_at: disc.created_at || disc.createdAt || now
                }));

                if (discData.length > 0) {
                    const { errors } = await batchUpsert('billing_discrepancies', discData, 'id');
                    if (errors.length > 0) console.warn('Discrepancy sync errors:', errors);
                }

                // Prepare bank transactions
                const bankTxnData = (appData.bankTransactions || []).map(txn => ({
                    id: txn.id,
                    statement_id: txn.statementId || txn.statement_id || null,
                    transaction_date: txn.date || txn.transaction_date || now.slice(0, 10),
                    post_date: txn.postDate || txn.post_date || null,
                    description: txn.description || 'No description',
                    original_description: txn.originalDescription || txn.original_description || null,
                    amount: parseFloat(txn.amount) || 0,
                    transaction_type: txn.type || txn.transaction_type || 'expense',
                    category_id: txn.categoryId || txn.category_id || null,
                    is_reconciled: txn.isReconciled || txn.is_reconciled || false,
                    reconciled_with_stripe: txn.reconciledWithStripe || txn.reconciled_with_stripe || null,
                    is_tax_deductible: txn.isTaxDeductible || txn.is_tax_deductible || false,
                    notes: txn.notes || null
                }));

                if (bankTxnData.length > 0) {
                    const { errors } = await batchUpsert('bank_transactions', bankTxnData, 'id');
                    if (errors.length > 0) console.warn('Bank transaction sync errors:', errors);
                }

                syncManager.lastSyncTime = new Date();
                syncStatus = 'online';
                updateSyncStatus();
                console.log('Sync to Supabase completed:', syncManager.lastSyncTime);

            } catch (error) {
                console.error('Sync to Supabase failed:', error);
                syncStatus = 'error';
                updateSyncStatus();
            } finally {
                syncManager.releaseLock();
            }
        }

        async function syncFromSupabase() {
            if (!supabaseClient) return;

            await syncManager.acquireLock();
            updateSyncStatus('syncing');

            try {
                // Fetch all data from Supabase
                const [membersRes, txnsRes, discRes, bankTxnsRes] = await Promise.all([
                    supabaseClient.from('members').select('*').order('updated_at', { ascending: false }),
                    supabaseClient.from('stripe_transactions').select('*').order('transaction_date', { ascending: false }),
                    supabaseClient.from('billing_discrepancies').select('*').order('created_at', { ascending: false }),
                    supabaseClient.from('bank_transactions').select('*').order('transaction_date', { ascending: false })
                ]);

                // Process members with merge
                if (!membersRes.error && membersRes.data) {
                    const remoteMembers = membersRes.data.map(m => ({
                        id: m.id,
                        email: m.email,
                        name: m.name,
                        fullName: m.name,
                        kajabiId: m.kajabi_id,
                        kajabi_id: m.kajabi_id,
                        plan: m.subscription_plan,
                        subscription_plan: m.subscription_plan,
                        offerName: m.subscription_plan,
                        amount: m.subscription_amount,
                        subscription_amount: m.subscription_amount,
                        billingFrequency: m.billing_frequency,
                        billing_frequency: m.billing_frequency,
                        status: m.subscription_status,
                        subscription_status: m.subscription_status,
                        joinDate: m.join_date,
                        join_date: m.join_date,
                        createdAt: m.created_at,
                        created_at: m.created_at,
                        lastPaymentDate: m.last_payment_date,
                        last_payment_date: m.last_payment_date,
                        totalPaid: m.total_paid,
                        total_paid: m.total_paid,
                        notes: m.notes,
                        updated_at: m.updated_at
                    }));

                    const { merged, conflicts } = mergeArrays(appData.members || [], remoteMembers, 'email');
                    if (conflicts.length > 0) {
                        console.warn(`${conflicts.length} member conflicts resolved`);
                    }
                    appData.members = merged;
                }

                // Process stripe transactions
                if (!txnsRes.error && txnsRes.data) {
                    const remoteTxns = txnsRes.data.map(t => ({
                        id: t.stripe_id,
                        stripe_id: t.stripe_id,
                        stripeId: t.stripe_id,
                        account: t.stripe_account,
                        stripe_account: t.stripe_account,
                        stripeAccount: t.stripe_account,
                        email: t.member_email,
                        member_email: t.member_email,
                        customerEmail: t.member_email,
                        name: t.customer_name,
                        customer_name: t.customer_name,
                        customerName: t.customer_name,
                        amount: t.amount,
                        fee: t.fee,
                        net_amount: t.net_amount,
                        netAmount: t.net_amount,
                        status: t.status,
                        date: t.transaction_date,
                        transaction_date: t.transaction_date,
                        created: t.transaction_date,
                        description: t.description,
                        product_name: t.product_name,
                        productName: t.product_name,
                        updated_at: t.created_at
                    }));

                    const { merged } = mergeArrays(appData.stripeTransactions || [], remoteTxns, 'stripe_id');
                    appData.stripeTransactions = merged;
                }

                // Process discrepancies
                if (!discRes.error && discRes.data) {
                    const remoteDisc = discRes.data.map(d => ({
                        id: d.id,
                        email: d.member_email,
                        member_email: d.member_email,
                        memberEmail: d.member_email,
                        name: d.member_name,
                        member_name: d.member_name,
                        memberName: d.member_name,
                        type: d.discrepancy_type,
                        discrepancy_type: d.discrepancy_type,
                        discrepancyType: d.discrepancy_type,
                        expectedAmount: d.expected_amount,
                        expected_amount: d.expected_amount,
                        actualAmount: d.actual_amount,
                        actual_amount: d.actual_amount,
                        difference: d.difference,
                        stripeAccount: d.stripe_account,
                        stripe_account: d.stripe_account,
                        status: d.status,
                        priority: d.priority,
                        notes: d.resolution_notes,
                        resolution_notes: d.resolution_notes,
                        resolutionNotes: d.resolution_notes,
                        createdAt: d.created_at,
                        created_at: d.created_at,
                        resolved_at: d.resolved_at,
                        resolved_by: d.resolved_by,
                        updated_at: d.created_at
                    }));

                    const { merged } = mergeArrays(appData.discrepancies || [], remoteDisc, 'id');
                    appData.discrepancies = merged;
                }

                // Process bank transactions
                if (!bankTxnsRes.error && bankTxnsRes.data) {
                    const remoteBankTxns = bankTxnsRes.data.map(t => ({
                        id: t.id,
                        statementId: t.statement_id,
                        statement_id: t.statement_id,
                        date: t.transaction_date,
                        transaction_date: t.transaction_date,
                        postDate: t.post_date,
                        post_date: t.post_date,
                        description: t.description,
                        originalDescription: t.original_description,
                        original_description: t.original_description,
                        amount: t.amount,
                        type: t.transaction_type,
                        transaction_type: t.transaction_type,
                        categoryId: t.category_id,
                        category_id: t.category_id,
                        isReconciled: t.is_reconciled,
                        is_reconciled: t.is_reconciled,
                        reconciledWithStripe: t.reconciled_with_stripe,
                        reconciled_with_stripe: t.reconciled_with_stripe,
                        isTaxDeductible: t.is_tax_deductible,
                        is_tax_deductible: t.is_tax_deductible,
                        notes: t.notes,
                        createdAt: t.created_at,
                        updated_at: t.created_at
                    }));

                    const { merged } = mergeArrays(appData.bankTransactions || [], remoteBankTxns, 'id');
                    appData.bankTransactions = merged;
                }

                // Save merged data
                saveToLocalStorage(false);

                syncManager.lastSyncTime = new Date();
                syncStatus = 'online';
                updateSyncStatus();
                console.log('Sync from Supabase completed:', syncManager.lastSyncTime);

                // Refresh UI
                if (typeof refreshMembersTable === 'function') refreshMembersTable();
                if (typeof refreshDashboard === 'function') refreshDashboard();
                if (typeof refreshBookkeeping === 'function') refreshBookkeeping();

            } catch (error) {
                console.error('Sync from Supabase failed:', error);
                syncStatus = 'error';
                updateSyncStatus();
            } finally {
                syncManager.releaseLock();
            }
        }

        // ============================================
        // REALTIME SUBSCRIPTIONS FOR CONFLICT DETECTION
        // ============================================

        async function setupRealtimeSubscriptions() {
            if (!supabaseClient) return;

            try {
                // Subscribe to members table changes
                const membersChannel = supabaseClient
                    .channel('members-changes')
                    .on('postgres_changes',
                        { event: '*', schema: 'public', table: 'members' },
                        (payload) => handleRealtimeChange('members', payload)
                    )
                    .subscribe();

                // Subscribe to stripe transactions
                const txnsChannel = supabaseClient
                    .channel('transactions-changes')
                    .on('postgres_changes',
                        { event: '*', schema: 'public', table: 'stripe_transactions' },
                        (payload) => handleRealtimeChange('stripe_transactions', payload)
                    )
                    .subscribe();

                // Subscribe to discrepancies
                const discChannel = supabaseClient
                    .channel('discrepancies-changes')
                    .on('postgres_changes',
                        { event: '*', schema: 'public', table: 'billing_discrepancies' },
                        (payload) => handleRealtimeChange('billing_discrepancies', payload)
                    )
                    .subscribe();

                syncManager.realtimeSubscriptions = [membersChannel, txnsChannel, discChannel];
                console.log('Realtime subscriptions established');

            } catch (error) {
                console.warn('Failed to setup realtime subscriptions:', error);
            }
        }

        function handleRealtimeChange(table, payload) {
            console.log(`Realtime change in ${table}:`, payload.eventType);

            // Check if this change conflicts with pending local changes
            const recordKey = `${table}:${payload.new?.id || payload.new?.email || payload.old?.id}`;
            const localStatus = appData.syncStatus?.[recordKey];

            if (localStatus?.status === 'pending') {
                console.warn(`Conflict detected: Remote change to ${recordKey} while local change is pending`);
                // Mark as conflicted for user resolution
                appData.syncStatus[recordKey] = {
                    ...localStatus,
                    status: 'conflict',
                    remoteChange: payload.new,
                    conflictTime: new Date().toISOString()
                };
                updateSyncStatus('error');

                // Notify user of conflict
                const conflictCount = Object.values(appData.syncStatus || {})
                    .filter(s => s.status === 'conflict').length;
                if (conflictCount > 0) {
                    console.warn(`${conflictCount} sync conflict(s) need resolution`);
                }
            } else {
                // No conflict - can auto-merge
                if (payload.eventType === 'INSERT' || payload.eventType === 'UPDATE') {
                    // Schedule a sync to pull the new data
                    setTimeout(() => syncFromSupabase(), 1000);
                }
            }
        }

        async function fullSync() {
            if (!supabaseClient) {
                console.log('Supabase not connected, skipping sync');
                return;
            }

            // First replay any queued operations
            await replaySyncQueue();

            // Then pull from cloud with merge
            await syncFromSupabase();
        }

        // Manual sync button handler
        async function triggerManualSync() {
            if (supabaseClient) {
                // Force push local changes first
                await syncToSupabase();
                // Then pull and merge
                await syncFromSupabase();
            } else {
                alert('Cloud sync is not available. Running in offline mode.');
            }
        }

        // Get sync status for a specific record
        function getRecordSyncStatus(table, recordId) {
            const key = `${table}:${recordId}`;
            return appData.syncStatus?.[key] || { status: 'unknown' };
        }

        // Get count of pending/failed sync operations
        function getPendingSyncCount() {
            const queue = appData.syncQueue || [];
            return {
                pending: queue.filter(i => i.status === 'pending').length,
                failed: queue.filter(i => i.status === 'failed').length,
                conflicts: Object.values(appData.syncStatus || {}).filter(s => s.status === 'conflict').length
            };
        }

        function setupEventListeners() {
            // Login form
            document.getElementById('login-form').addEventListener('submit', handleLogin);

            // Navigation
            document.querySelectorAll('.nav-item').forEach(item => {
                item.addEventListener('click', function() {
                    showTab(this.dataset.tab);
                });
            });

            // Close modals on overlay click
            document.querySelectorAll('.modal-overlay').forEach(overlay => {
                overlay.addEventListener('click', function(e) {
                    if (e.target === this) {
                        this.classList.remove('active');
                    }
                });
            });

            // Member search
            const memberSearch = document.getElementById('member-search');
            if (memberSearch) {
                memberSearch.addEventListener('input', filterMembers);
            }

            // Member status filter
            const statusFilter = document.getElementById('member-status-filter');
            if (statusFilter) {
                statusFilter.addEventListener('change', filterMembers);
            }
        }

        // ============================================
        // AUTHENTICATION
        // ============================================

        async function checkAuth() {
            // Check for existing Supabase session
            if (supabaseClient) {
                try {
                    const { data: { session }, error } = await supabaseClient.auth.getSession();
                    if (session && session.user) {
                        const email = session.user.email;
                        const profile = userProfiles[email] || {
                            name: email.split('@')[0],
                            role: 'user',
                            initials: email.substring(0, 2).toUpperCase()
                        };
                        currentUser = { ...profile, email };
                        showApp();
                        return;
                    }
                } catch (e) {
                    console.warn('Auth check failed:', e);
                }
            }
            showLogin();
        }

        // Login rate limiting
        const loginRateLimiter = {
            attempts: 0,
            lastAttempt: 0,
            lockoutUntil: 0,
            MAX_ATTEMPTS: 5,
            LOCKOUT_DURATION: 60000, // 1 minute
            ATTEMPT_WINDOW: 300000,  // 5 minutes

            canAttempt() {
                const now = Date.now();
                // Check if currently locked out
                if (now < this.lockoutUntil) {
                    const remainingSeconds = Math.ceil((this.lockoutUntil - now) / 1000);
                    return { allowed: false, message: `Too many attempts. Please wait ${remainingSeconds} seconds.` };
                }
                // Reset attempts if window expired
                if (now - this.lastAttempt > this.ATTEMPT_WINDOW) {
                    this.attempts = 0;
                }
                return { allowed: true };
            },

            recordAttempt(success) {
                const now = Date.now();
                this.lastAttempt = now;
                if (success) {
                    this.attempts = 0;
                    this.lockoutUntil = 0;
                } else {
                    this.attempts++;
                    if (this.attempts >= this.MAX_ATTEMPTS) {
                        // Progressive lockout: doubles each time
                        const lockoutMultiplier = Math.pow(2, Math.floor(this.attempts / this.MAX_ATTEMPTS) - 1);
                        this.lockoutUntil = now + (this.LOCKOUT_DURATION * lockoutMultiplier);
                    }
                }
            }
        };

        async function handleLogin(e) {
            e.preventDefault();
            const email = document.getElementById('login-email').value;
            const password = document.getElementById('login-password').value;
            const errorEl = document.getElementById('login-error');
            const loginBtn = document.getElementById('login-btn');

            if (!email || !password) {
                errorEl.textContent = 'Please enter email and password.';
                errorEl.classList.add('show');
                return;
            }

            // Check rate limiting
            const rateLimitCheck = loginRateLimiter.canAttempt();
            if (!rateLimitCheck.allowed) {
                errorEl.textContent = rateLimitCheck.message;
                errorEl.classList.add('show');
                return;
            }

            // Disable button during login
            loginBtn.disabled = true;
            loginBtn.textContent = 'Signing in...';

            try {
                if (!supabaseClient) {
                    throw new Error('Authentication service unavailable. Please refresh the page.');
                }

                const { data, error } = await supabaseClient.auth.signInWithPassword({
                    email: email,
                    password: password
                });

                if (error) {
                    throw error;
                }

                if (data.user) {
                    // Record successful login
                    loginRateLimiter.recordAttempt(true);

                    const profile = userProfiles[email] || {
                        name: email.split('@')[0],
                        role: 'user',
                        initials: email.substring(0, 2).toUpperCase()
                    };
                    currentUser = { ...profile, email };
                    errorEl.classList.remove('show');

                    // Sync data from Supabase now that we're authenticated
                    await fullSync();

                    showApp();
                }
            } catch (error) {
                // Record failed login
                loginRateLimiter.recordAttempt(false);

                console.error('Login error:', error);
                // Sanitize error message - don't expose internal details
                let safeMessage = 'Invalid credentials. Please try again.';
                if (error.message?.includes('Invalid login')) {
                    safeMessage = 'Invalid email or password.';
                } else if (error.message?.includes('Email not confirmed')) {
                    safeMessage = 'Please verify your email address.';
                } else if (error.message?.includes('rate')) {
                    safeMessage = 'Too many attempts. Please try again later.';
                }
                // Add attempt warning if getting close to lockout
                if (loginRateLimiter.attempts >= 3) {
                    safeMessage += ` (${loginRateLimiter.MAX_ATTEMPTS - loginRateLimiter.attempts} attempts remaining)`;
                }
                errorEl.textContent = safeMessage;
                errorEl.classList.add('show');
            } finally {
                loginBtn.disabled = false;
                loginBtn.textContent = 'Sign In';
            }
        }

        async function logout() {
            if (supabaseClient) {
                await supabaseClient.auth.signOut();
            }
            currentUser = null;
            showLogin();
        }

        function showLogin() {
            document.getElementById('login-screen').classList.remove('hidden');
            document.getElementById('main-app').classList.remove('active');
            document.getElementById('login-password').value = '';
            document.getElementById('login-email').value = '';
        }

        function showApp() {
            document.getElementById('login-screen').classList.add('hidden');
            document.getElementById('main-app').classList.add('active');

            // Update header with user info
            document.getElementById('user-display-name').textContent = currentUser.name;
            document.getElementById('user-role').textContent = currentUser.role === 'admin' ? 'Admin' : 'Full Admin';
            document.getElementById('user-avatar').textContent = currentUser.initials;

            // Show/hide admin-only sections
            const adminSection = document.getElementById('user-management-section');
            if (adminSection) {
                adminSection.style.display = currentUser.role === 'admin' ? 'block' : 'none';
            }

            // Refresh dashboard
            refreshDashboard();
        }

        // ============================================
        // NAVIGATION
        // ============================================

        function showTab(tabName) {
            // Update nav
            document.querySelectorAll('.nav-item').forEach(item => {
                item.classList.toggle('active', item.dataset.tab === tabName);
            });

            // Update content
            document.querySelectorAll('.page-content').forEach(page => {
                page.classList.toggle('active', page.id === `page-${tabName}`);
            });

            // Refresh data for specific tabs
            if (tabName === 'dashboard') {
                refreshDashboard();
            } else if (tabName === 'members') {
                refreshMembersTable();
            } else if (tabName === 'bookkeeping') {
                refreshBookkeeping();
            } else if (tabName === 'reports') {
                refreshReports();
            } else if (tabName === 'reconciliation') {
                renderDiscrepanciesTable();
            }
        }

        // ============================================
        // MODAL FUNCTIONS
        // ============================================

        function openModal(modalId) {
            document.getElementById(modalId).classList.add('active');

            // Set defaults for specific modals
            if (modalId === 'add-transaction-modal') {
                // Set today's date as default
                const today = new Date().toISOString().split('T')[0];
                document.getElementById('txn-date').value = today;
                populateCategoryDropdowns();
            } else if (modalId === 'manage-categories-modal') {
                renderCategoriesList();
            } else if (modalId === 'vendor-mappings-modal') {
                populateCategoryDropdowns();
                renderVendorMappingsList();
            }
        }

        function closeModal(modalId) {
            document.getElementById(modalId).classList.remove('active');
        }

        function openChangePasswordModal() {
            if (!currentUser) {
                alert('You must be logged in to change your password.');
                return;
            }
            document.getElementById('change-password-user').textContent = currentUser.name;
            document.getElementById('new-password').value = '';
            document.getElementById('confirm-password').value = '';
            openModal('change-password-modal');
        }

        // Password strength validation
        function validatePasswordStrength(password) {
            const errors = [];
            if (password.length < 8) {
                errors.push('at least 8 characters');
            }
            if (!/[A-Z]/.test(password)) {
                errors.push('one uppercase letter');
            }
            if (!/[a-z]/.test(password)) {
                errors.push('one lowercase letter');
            }
            if (!/[0-9]/.test(password)) {
                errors.push('one number');
            }
            if (!/[!@#$%^&*()_+\-=\[\]{};':"\\|,.<>\/?]/.test(password)) {
                errors.push('one special character (!@#$%^&*...)');
            }
            return errors;
        }

        async function savePassword() {
            const newPassword = document.getElementById('new-password').value;
            const confirmPassword = document.getElementById('confirm-password').value;

            if (!newPassword) {
                alert('Please enter a new password.');
                return;
            }

            if (newPassword !== confirmPassword) {
                alert('Passwords do not match.');
                return;
            }

            // Strong password validation
            const passwordErrors = validatePasswordStrength(newPassword);
            if (passwordErrors.length > 0) {
                alert('Password must contain:\nâ€¢ ' + passwordErrors.join('\nâ€¢ '));
                return;
            }

            try {
                if (!supabaseClient) {
                    throw new Error('Authentication service unavailable.');
                }

                const { error } = await supabaseClient.auth.updateUser({
                    password: newPassword
                });

                if (error) throw error;

                closeModal('change-password-modal');
                alert('Password updated successfully!');
            } catch (error) {
                console.error('Password update error:', error);
                // Sanitize error message - don't expose internal details
                const safeMessage = error.message?.includes('weak') ?
                    'Password is too weak. Please choose a stronger password.' :
                    'Failed to update password. Please try again.';
                alert(safeMessage);
            }
        }

        // ============================================
        // DASHBOARD
        // ============================================

        function refreshDashboard() {
            // Calculate stats from appData
            const activeMembers = appData.members.filter(m => m.subscription_status === 'active');
            const pastDueMembers = appData.members.filter(m => m.subscription_status === 'past_due');
            const mrr = activeMembers.reduce((sum, m) => sum + (parseFloat(m.subscription_amount) || 0), 0);
            const outstanding = pastDueMembers.reduce((sum, m) => sum + (parseFloat(m.subscription_amount) || 0), 0);

            // Failed payments this month
            const thisMonth = new Date();
            thisMonth.setDate(1);
            const failedPayments = appData.stripeTransactions.filter(t =>
                t.status === 'failed' &&
                new Date(t.transaction_date) >= thisMonth
            );
            const failedAmount = failedPayments.reduce((sum, t) => sum + (parseFloat(t.amount) || 0), 0);

            // Update stats
            document.getElementById('stat-mrr').textContent = formatCurrency(mrr);
            document.getElementById('stat-members').textContent = activeMembers.length;
            document.getElementById('stat-outstanding').textContent = formatCurrency(outstanding);
            document.getElementById('outstanding-count').textContent = `${pastDueMembers.length} members`;
            document.getElementById('stat-failed').textContent = failedPayments.length;
            document.getElementById('failed-amount').textContent = `$${formatCurrency(failedAmount)} this month`;

            // Update issues count
            const openIssues = appData.discrepancies.filter(d => d.status === 'open').length;
            document.getElementById('issues-count').textContent = openIssues;

            // Update recent transactions
            updateRecentTransactions();

            // Update billing issues
            updateBillingIssues();

            // Update alerts
            updateDashboardAlerts();
        }

        function updateRecentTransactions() {
            const container = document.getElementById('recent-transactions');
            const transactions = appData.stripeTransactions
                .sort((a, b) => new Date(b.transaction_date) - new Date(a.transaction_date))
                .slice(0, 5);

            if (transactions.length === 0) {
                container.innerHTML = `
                    <li class="empty-state">
                        <div class="empty-state-icon">&#128179;</div>
                        <div class="empty-state-title">No transactions yet</div>
                        <div class="empty-state-message">Import your Stripe data to see transactions here</div>
                    </li>
                `;
                return;
            }

            container.innerHTML = transactions.map(t => `
                <li class="recent-item">
                    <div class="recent-info">
                        <div class="recent-avatar">${escapeHtml(getInitials(t.customer_name || t.member_email))}</div>
                        <div>
                            <div class="recent-name">${escapeHtml(t.customer_name || t.member_email || 'Unknown')}</div>
                            <div class="recent-detail">${escapeHtml(formatDate(t.transaction_date))} Â· ${escapeHtml(t.stripe_account)}</div>
                        </div>
                    </div>
                    <div class="recent-amount ${t.status === 'succeeded' ? 'positive' : 'negative'}">
                        ${t.status === 'succeeded' ? '+' : ''}$${escapeHtml(formatCurrency(t.amount))}
                    </div>
                </li>
            `).join('');
        }

        function updateBillingIssues() {
            const container = document.getElementById('billing-issues');
            const issues = appData.discrepancies
                .filter(d => d.status === 'open')
                .slice(0, 5);

            if (issues.length === 0) {
                container.innerHTML = `
                    <li class="empty-state">
                        <div class="empty-state-icon">&#9989;</div>
                        <div class="empty-state-title">All clear!</div>
                        <div class="empty-state-message">No billing issues found. Run a reconciliation to check for discrepancies.</div>
                    </li>
                `;
                return;
            }

            container.innerHTML = issues.map(d => `
                <li class="recent-item">
                    <div class="recent-info">
                        <div class="recent-avatar" style="background: var(--danger-light); color: var(--danger);">!</div>
                        <div>
                            <div class="recent-name">${escapeHtml(d.member_name || d.member_email || 'Unknown')}</div>
                            <div class="recent-detail">${escapeHtml(formatDiscrepancyType(d.discrepancy_type))}</div>
                        </div>
                    </div>
                    <span class="badge badge-danger">${escapeHtml(d.priority || 'medium')}</span>
                </li>
            `).join('');
        }

        function updateDashboardAlerts() {
            const container = document.getElementById('dashboard-alerts');
            const alerts = [];

            // Check for high-priority discrepancies
            const criticalIssues = appData.discrepancies.filter(d =>
                d.status === 'open' && d.priority === 'critical'
            );
            if (criticalIssues.length > 0) {
                alerts.push({
                    type: 'danger',
                    title: 'Critical Billing Issues',
                    message: `${criticalIssues.length} critical billing issues require immediate attention.`
                });
            }

            // Check for past due members
            const pastDue = appData.members.filter(m => m.subscription_status === 'past_due');
            if (pastDue.length > 0) {
                alerts.push({
                    type: 'warning',
                    title: 'Past Due Members',
                    message: `${pastDue.length} members have past due payments.`
                });
            }

            // Check if data needs refresh
            const lastImport = appData.importLogs[appData.importLogs.length - 1];
            if (!lastImport) {
                alerts.push({
                    type: 'info',
                    title: 'Get Started',
                    message: 'Import your Kajabi and Stripe data to begin tracking your mastermind billing.'
                });
            }

            if (alerts.length === 0) {
                container.innerHTML = '';
                return;
            }

            container.innerHTML = alerts.map(a => `
                <div class="alert alert-${escapeHtml(a.type)}">
                    <div class="alert-icon">${a.type === 'danger' ? '&#9888;' : a.type === 'warning' ? '&#9888;' : '&#128161;'}</div>
                    <div class="alert-content">
                        <div class="alert-title">${escapeHtml(a.title)}</div>
                        <div class="alert-message">${escapeHtml(a.message)}</div>
                    </div>
                </div>
            `).join('');
        }

        // ============================================
        // MEMBERS
        // ============================================

        function refreshMembersTable() {
            const members = appData.members;

            // Update stats
            document.getElementById('members-total').textContent = members.length;
            document.getElementById('members-active').textContent = members.filter(m => m.subscription_status === 'active').length;
            document.getElementById('members-pastdue').textContent = members.filter(m => m.subscription_status === 'past_due').length;

            // Calculate canceled this month
            const thisMonth = new Date();
            thisMonth.setDate(1);
            const canceledThisMonth = members.filter(m =>
                m.subscription_status === 'canceled' &&
                m.updated_at && new Date(m.updated_at) >= thisMonth
            ).length;
            document.getElementById('members-canceled').textContent = canceledThisMonth;

            // Render table
            filterMembers();
        }

        function filterMembers() {
            const search = (document.getElementById('member-search').value || '').toLowerCase();
            const statusFilter = document.getElementById('member-status-filter').value;

            let filtered = appData.members;

            if (search) {
                filtered = filtered.filter(m =>
                    (m.name || '').toLowerCase().includes(search) ||
                    (m.email || '').toLowerCase().includes(search)
                );
            }

            if (statusFilter) {
                filtered = filtered.filter(m => m.subscription_status === statusFilter);
            }

            renderMembersTable(filtered);
        }

        function renderMembersTable(members) {
            const tbody = document.getElementById('members-table-body');

            if (members.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="7" class="text-center text-muted" style="padding: 3rem;">
                            ${appData.members.length === 0
                                ? 'No members yet. Import your Kajabi CSV to get started.'
                                : 'No members match your filters.'}
                        </td>
                    </tr>
                `;
                return;
            }

            tbody.innerHTML = members.map(m => `
                <tr>
                    <td><strong>${escapeHtml(m.name || 'Unknown')}</strong></td>
                    <td>${escapeHtml(m.email || '-')}</td>
                    <td>${escapeHtml(m.subscription_plan || '-')}</td>
                    <td>$${escapeHtml(formatCurrency(m.subscription_amount))}</td>
                    <td>${getStatusBadge(m.subscription_status)}</td>
                    <td>${escapeHtml(m.last_payment_date ? formatDate(m.last_payment_date) : '-')}</td>
                    <td>
                        <button class="btn btn-sm btn-outline" data-member-id="${escapeHtml(m.id || m.email)}" onclick="viewMember(this.dataset.memberId)">View</button>
                    </td>
                </tr>
            `).join('');
        }

        function getStatusBadge(status) {
            const badges = {
                'active': '<span class="badge badge-success">Active</span>',
                'past_due': '<span class="badge badge-warning">Past Due</span>',
                'canceled': '<span class="badge badge-danger">Canceled</span>',
                'trialing': '<span class="badge badge-info">Trialing</span>',
                'paused': '<span class="badge badge-neutral">Paused</span>'
            };
            return badges[status] || '<span class="badge badge-neutral">Unknown</span>';
        }

        function viewMember(memberId) {
            const member = appData.members.find(m => m.id === memberId || m.email === memberId);
            if (!member) {
                alert('Member not found');
                return;
            }

            // Get payment history for this member
            const payments = appData.stripeTransactions
                .filter(t => t.member_email === member.email)
                .sort((a, b) => new Date(b.transaction_date || b.date) - new Date(a.transaction_date || a.date));

            // Calculate total paid
            const totalPaid = payments
                .filter(p => p.status === 'succeeded')
                .reduce((sum, p) => sum + parseFloat(p.amount || 0), 0);

            // Get initials
            const name = member.name || member.fullName || 'Unknown';
            const initials = name.split(' ').map(n => n[0]).join('').toUpperCase().substring(0, 2);

            // Populate modal
            document.getElementById('member-detail-avatar').textContent = initials;
            document.getElementById('member-detail-name').textContent = name;
            document.getElementById('member-detail-email').textContent = member.email || '--';

            // Status badge
            const status = member.subscription_status || member.status || 'unknown';
            const statusBadge = getStatusBadge(status);
            document.getElementById('member-detail-status-badge').innerHTML = statusBadge;

            // Stats
            document.getElementById('member-detail-rate').textContent = '$' + formatCurrency(member.subscription_amount || member.amount || 0);
            document.getElementById('member-detail-total').textContent = '$' + formatCurrency(totalPaid);

            const joinDate = member.join_date || member.joinDate || member.createdAt;
            document.getElementById('member-detail-since').textContent = joinDate ? formatDate(joinDate) : '--';

            // Subscription details
            document.getElementById('member-detail-plan').textContent = member.subscription_plan || member.plan || member.offerName || 'Standard';
            document.getElementById('member-detail-frequency').textContent = (member.billing_frequency || member.billingFrequency || 'monthly').charAt(0).toUpperCase() + (member.billing_frequency || member.billingFrequency || 'monthly').slice(1);

            const lastPayment = payments.find(p => p.status === 'succeeded');
            document.getElementById('member-detail-last-payment').textContent = lastPayment ? formatDate(lastPayment.transaction_date || lastPayment.date) : 'No payments';
            document.getElementById('member-detail-kajabi-id').textContent = member.kajabi_id || member.kajabiId || '--';

            // Payment history table
            const paymentsBody = document.getElementById('member-detail-payments');
            if (payments.length === 0) {
                paymentsBody.innerHTML = `<tr><td colspan="4" class="text-center text-muted" style="padding: 2rem;">No payment history found</td></tr>`;
            } else {
                paymentsBody.innerHTML = payments.slice(0, 20).map(p => {
                    const statusClass = p.status === 'succeeded' ? 'success' : p.status === 'failed' ? 'danger' : 'warning';
                    return `
                        <tr>
                            <td>${escapeHtml(formatDate(p.transaction_date || p.date))}</td>
                            <td>$${escapeHtml(formatCurrency(p.amount))}</td>
                            <td><span class="badge badge-${escapeHtml(statusClass)}">${escapeHtml(p.status || 'unknown')}</span></td>
                            <td>${escapeHtml(p.stripe_account || p.account || '--')}</td>
                        </tr>
                    `;
                }).join('');
            }

            // Notes
            document.getElementById('member-detail-notes').value = member.notes || '';
            document.getElementById('member-detail-notes').dataset.memberId = member.id || member.email;

            openModal('member-details-modal');
        }

        function saveMemberNotes() {
            const notesField = document.getElementById('member-detail-notes');
            const memberId = notesField.dataset.memberId;
            const notes = notesField.value;

            const member = appData.members.find(m => m.id === memberId || m.email === memberId);
            if (member) {
                member.notes = notes;
                saveToLocalStorage(true);  // Sync member notes to cloud
                alert('Notes saved!');
            }
        }

        // ============================================
        // CSV IMPORT
        // ============================================

        function importKajabiCSV() {
            const fileInput = document.getElementById('kajabi-file');
            const file = fileInput.files[0];

            if (!file) {
                alert('Please select a CSV file.');
                return;
            }

            Papa.parse(file, {
                header: true,
                skipEmptyLines: true,
                complete: function(results) {
                    processKajabiImport(results.data);
                    closeModal('import-kajabi-modal');
                    fileInput.value = '';
                },
                error: function(error) {
                    alert('Error parsing CSV: ' + error.message);
                }
            });
        }

        function processKajabiImport(data) {
            let imported = 0;
            let updated = 0;
            let skipped = 0;

            // Debug: log first row to see column names
            if (data.length > 0) {
                console.log('CSV columns found:', Object.keys(data[0]));
            }

            data.forEach(row => {
                // Try common Kajabi column names (including subscriptions.csv format)
                const email = row['Customer Email'] || row['Email'] || row['email'] || row['Email Address'];
                if (!email) {
                    skipped++;
                    return;
                }

                // Parse amount - handle "$30.00" format
                let amount = row['Amount'] || row['Price'] || '0';
                if (typeof amount === 'string') {
                    amount = amount.replace(/[$,]/g, ''); // Remove $ and commas
                }
                amount = parseFloat(amount) || 0;

                // Get billing interval
                const interval = row['Interval'] || 'Month';
                const billingFrequency = interval.toLowerCase().includes('year') ? 'annual' : 'monthly';

                const memberData = {
                    id: generateId(),
                    email: email.toLowerCase().trim(),
                    name: row['Customer Name'] || row['Full Name'] || row['Name'] || '',
                    subscription_plan: row['Offer Title'] || row['Offer Name'] || row['Product'] || row['Membership'] || '',
                    subscription_amount: amount,
                    billing_frequency: billingFrequency,
                    subscription_status: mapKajabiStatus(row['Status'] || row['Subscription Status']),
                    kajabi_id: row['Kajabi Subscription ID'] || row['Customer ID'] || '',
                    join_date: row['Created At'] || row['Joined'] || new Date().toISOString(),
                    next_payment_date: row['Next Payment Date'] || '',
                    canceled_on: row['Canceled On'] || '',
                    provider: row['Provider'] || 'Kajabi',
                    updated_at: new Date().toISOString()
                };

                // Check if member exists
                const existingIndex = appData.members.findIndex(m => m.email === memberData.email);
                if (existingIndex >= 0) {
                    // Update existing
                    appData.members[existingIndex] = { ...appData.members[existingIndex], ...memberData };
                    updated++;
                } else {
                    // Add new
                    appData.members.push(memberData);
                    imported++;
                }
            });

            // Log import
            appData.importLogs.push({
                id: generateId(),
                import_type: 'kajabi_members',
                file_name: document.getElementById('kajabi-file').files[0]?.name,
                records_imported: imported,
                records_updated: updated,
                records_skipped: skipped,
                imported_by: currentUser.name,
                imported_at: new Date().toISOString()
            });

            saveToLocalStorage(true);  // Push to Supabase after import
            refreshMembersTable();
            refreshDashboard();

            document.getElementById('kajabi-last-import').textContent = 'Just now';

            alert(`Import complete!\n\nImported: ${imported}\nUpdated: ${updated}\nSkipped: ${skipped}`);
        }

        function mapKajabiStatus(status) {
            if (!status) return 'active';
            const s = status.toLowerCase().trim();
            if (s === 'active') return 'active';
            if (s === 'canceled' || s === 'cancelled') return 'canceled';
            if (s === 'paused') return 'paused';
            if (s.includes('past') || s.includes('due')) return 'past_due';
            if (s.includes('trial')) return 'trialing';
            if (s.includes('cancel')) return 'canceled';
            if (s.includes('pause')) return 'paused';
            return 'active';
        }

        // Helper to parse currency amounts like "$30.00" or "30.0"
        function parseAmount(value) {
            if (!value) return 0;
            if (typeof value === 'number') return value;
            // Remove currency symbols, commas, and whitespace
            const cleaned = String(value).replace(/[$,\s]/g, '');
            return parseFloat(cleaned) || 0;
        }

        function importStripeCSV(account) {
            const fileId = account === 'reignation' ? 'stripe1-file' : 'stripe2-file';
            const modalId = account === 'reignation' ? 'import-stripe1-modal' : 'import-stripe2-modal';
            const fileInput = document.getElementById(fileId);
            const file = fileInput.files[0];

            if (!file) {
                alert('Please select a CSV file.');
                return;
            }

            Papa.parse(file, {
                header: true,
                skipEmptyLines: true,
                complete: function(results) {
                    processStripeImport(results.data, account);
                    closeModal(modalId);
                    fileInput.value = '';
                },
                error: function(error) {
                    alert('Error parsing CSV: ' + error.message);
                }
            });
        }

        function processStripeImport(data, account) {
            let imported = 0;
            let skipped = 0;

            // Log first row columns for debugging
            if (data.length > 0) {
                console.log('Stripe CSV columns found:', Object.keys(data[0]));
            }

            data.forEach(row => {
                // Try common Stripe column names (unified_payments.csv format)
                const stripeId = row['id'] || row['ID'] || row['Payment ID'];
                const amount = parseFloat(row['Amount'] || row['amount'] || 0);

                // Skip rows without amount (but allow rows without stripeId for canceled payments)
                if (!amount) {
                    skipped++;
                    return;
                }

                // Generate ID for rows without one (canceled payments)
                const finalStripeId = stripeId || `canceled_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;

                // Check for duplicate
                if (stripeId && appData.stripeTransactions.some(t => t.stripe_id === stripeId)) {
                    skipped++;
                    return;
                }

                // Get customer email - try multiple column names
                const customerEmail = (
                    row['Customer Email'] ||
                    row['customer_email'] ||
                    row['Email'] ||
                    row['email'] ||
                    ''
                ).toLowerCase().trim();

                // Get customer name - try multiple column names
                const customerName =
                    row['Customer Description'] ||
                    row['Customer Name'] ||
                    row['customer_name'] ||
                    row['Name'] ||
                    '';

                // Get date - unified_payments uses "Created date (UTC)"
                const transactionDate =
                    row['Created date (UTC)'] ||
                    row['Created (UTC)'] ||
                    row['created'] ||
                    row['Date'] ||
                    new Date().toISOString();

                // Amount is already in dollars (not cents) in unified_payments.csv
                const transaction = {
                    id: generateId(),
                    stripe_id: finalStripeId,
                    stripe_account: account,
                    member_email: customerEmail,
                    customer_name: customerName,
                    amount: amount, // Already in dollars
                    fee: parseFloat(row['Fee'] || row['fee'] || 0), // Already in dollars
                    status: mapStripeStatus(row['Status'] || row['status']),
                    transaction_date: transactionDate,
                    description: row['Description'] || row['description'] || ''
                };

                transaction.net_amount = transaction.amount - transaction.fee;

                // Try to match with member
                const member = appData.members.find(m => m.email === transaction.member_email);
                if (member) {
                    transaction.member_id = member.id;

                    // Update member's last payment date if this is newer
                    if (transaction.status === 'succeeded') {
                        const txnDate = new Date(transaction.transaction_date);
                        const lastPayment = member.last_payment_date ? new Date(member.last_payment_date) : new Date(0);
                        if (txnDate > lastPayment) {
                            member.last_payment_date = transaction.transaction_date;
                        }
                    }
                }

                appData.stripeTransactions.push(transaction);
                imported++;
            });

            // Log import
            appData.importLogs.push({
                id: generateId(),
                import_type: `stripe_${account}`,
                file_name: document.getElementById(account === 'reignation' ? 'stripe1-file' : 'stripe2-file').files[0]?.name,
                records_imported: imported,
                records_skipped: skipped,
                imported_by: currentUser.name,
                imported_at: new Date().toISOString()
            });

            saveToLocalStorage(true);  // Push to Supabase after import
            refreshDashboard();

            const lastImportId = account === 'reignation' ? 'stripe1-last-import' : 'stripe2-last-import';
            document.getElementById(lastImportId).textContent = 'Just now';

            alert(`Stripe import complete!\n\nImported: ${imported}\nSkipped (duplicates): ${skipped}`);
        }

        function mapStripeStatus(status) {
            if (!status) return 'succeeded';
            const s = status.toLowerCase().trim();
            if (s === 'paid' || s.includes('succeed') || s.includes('complete')) return 'succeeded';
            if (s === 'failed' || s.includes('fail')) return 'failed';
            if (s === 'canceled' || s.includes('cancel')) return 'canceled';
            if (s.includes('pending')) return 'pending';
            if (s.includes('refund')) return 'refunded';
            if (s.includes('refund')) return 'refunded';
            if (s.includes('dispute')) return 'disputed';
            return 'succeeded';
        }

        // ============================================
        // RECONCILIATION
        // ============================================

        function runReconciliation() {
            if (appData.members.length === 0) {
                alert('Please import Kajabi members first.');
                return;
            }

            if (appData.stripeTransactions.length === 0) {
                alert('Please import Stripe transactions first.');
                return;
            }

            const discrepancies = [];
            const now = new Date();
            const thirtyDaysAgo = new Date(now.getTime() - 30 * 24 * 60 * 60 * 1000);

            // Check each active member for payments
            appData.members.filter(m => m.subscription_status === 'active').forEach(member => {
                const memberTransactions = appData.stripeTransactions.filter(t =>
                    t.member_email === member.email &&
                    new Date(t.transaction_date) >= thirtyDaysAgo
                );

                const successfulPayments = memberTransactions.filter(t => t.status === 'succeeded');
                const failedPayments = memberTransactions.filter(t => t.status === 'failed');

                // Check for failed payments
                if (failedPayments.length > 0) {
                    discrepancies.push({
                        id: generateId(),
                        member_id: member.id,
                        member_email: member.email,
                        member_name: member.name,
                        discrepancy_type: 'failed_payment',
                        expected_amount: member.subscription_amount,
                        actual_amount: 0,
                        difference: member.subscription_amount,
                        status: 'open',
                        priority: 'high',
                        created_at: new Date().toISOString()
                    });
                }

                // Check for missing payments (active member with no recent payment)
                if (successfulPayments.length === 0 && member.subscription_amount > 0) {
                    discrepancies.push({
                        id: generateId(),
                        member_id: member.id,
                        member_email: member.email,
                        member_name: member.name,
                        discrepancy_type: 'missing_stripe_payment',
                        expected_amount: member.subscription_amount,
                        actual_amount: 0,
                        difference: member.subscription_amount,
                        status: 'open',
                        priority: 'medium',
                        created_at: new Date().toISOString()
                    });
                }
            });

            // Check for Stripe transactions without members
            appData.stripeTransactions
                .filter(t => t.status === 'succeeded' && new Date(t.transaction_date) >= thirtyDaysAgo)
                .forEach(txn => {
                    if (!appData.members.some(m => m.email === txn.member_email)) {
                        discrepancies.push({
                            id: generateId(),
                            member_email: txn.member_email,
                            member_name: txn.customer_name,
                            discrepancy_type: 'missing_kajabi_record',
                            expected_amount: 0,
                            actual_amount: txn.amount,
                            difference: txn.amount,
                            stripe_account: txn.stripe_account,
                            status: 'open',
                            priority: 'low',
                            created_at: new Date().toISOString()
                        });
                    }
                });

            // Clear old discrepancies and add new ones
            appData.discrepancies = discrepancies;
            saveToLocalStorage(true);  // Sync discrepancies to cloud

            refreshDashboard();
            renderDiscrepanciesTable();

            alert(`Reconciliation complete!\n\nFound ${discrepancies.length} issues.`);
        }

        // Pagination state for discrepancies
        let discrepancyPage = 1;
        let discrepancyPerPage = 10;

        function renderDiscrepanciesTable() {
            const tbody = document.getElementById('discrepancies-table-body');
            const filter = document.getElementById('discrepancy-filter').value;
            const countEl = document.getElementById('discrepancy-count');
            const paginationEl = document.getElementById('discrepancy-pagination');

            let discrepancies = appData.discrepancies.filter(d => d.status === 'open');

            if (filter) {
                discrepancies = discrepancies.filter(d => d.discrepancy_type === filter);
            }

            const totalItems = discrepancies.length;
            const totalPages = Math.ceil(totalItems / discrepancyPerPage);

            // Update count display
            countEl.textContent = totalItems > 0 ? `(${totalItems} issues)` : '';

            if (discrepancies.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="6" class="text-center text-muted" style="padding: 3rem;">
                            No discrepancies found. Run a reconciliation to check for issues.
                        </td>
                    </tr>
                `;
                paginationEl.style.display = 'none';
                return;
            }

            // Ensure current page is valid
            if (discrepancyPage > totalPages) discrepancyPage = totalPages;
            if (discrepancyPage < 1) discrepancyPage = 1;

            // Get items for current page
            const startIndex = (discrepancyPage - 1) * discrepancyPerPage;
            const endIndex = startIndex + discrepancyPerPage;
            const pageItems = discrepancies.slice(startIndex, endIndex);

            tbody.innerHTML = pageItems.map(d => `
                <tr>
                    <td>
                        <strong>${escapeHtml(d.member_name || 'Unknown')}</strong><br>
                        <span class="text-muted" style="font-size: 0.75rem;">${escapeHtml(d.member_email || '-')}</span>
                    </td>
                    <td>${escapeHtml(formatDiscrepancyType(d.discrepancy_type))}</td>
                    <td>$${escapeHtml(formatCurrency(d.expected_amount))}</td>
                    <td>$${escapeHtml(formatCurrency(d.actual_amount))}</td>
                    <td><span class="badge badge-${d.priority === 'high' ? 'danger' : d.priority === 'medium' ? 'warning' : 'info'}">${escapeHtml(d.priority)}</span></td>
                    <td>
                        <button class="btn btn-sm btn-outline" data-discrepancy-id="${escapeHtml(d.id)}" onclick="resolveDiscrepancy(this.dataset.discrepancyId)">Resolve</button>
                    </td>
                </tr>
            `).join('');

            // Update pagination UI
            if (totalPages > 1) {
                paginationEl.style.display = 'flex';
                document.getElementById('disc-page-info').textContent = `Page ${discrepancyPage} of ${totalPages} (${totalItems} items)`;
                document.getElementById('disc-page-first').disabled = discrepancyPage === 1;
                document.getElementById('disc-page-prev').disabled = discrepancyPage === 1;
                document.getElementById('disc-page-next').disabled = discrepancyPage === totalPages;
                document.getElementById('disc-page-last').disabled = discrepancyPage === totalPages;
            } else {
                paginationEl.style.display = 'none';
            }
        }

        function goToDiscrepancyPage(action) {
            const filter = document.getElementById('discrepancy-filter').value;
            let discrepancies = appData.discrepancies.filter(d => d.status === 'open');
            if (filter) {
                discrepancies = discrepancies.filter(d => d.discrepancy_type === filter);
            }
            const totalPages = Math.ceil(discrepancies.length / discrepancyPerPage);

            switch (action) {
                case 'first': discrepancyPage = 1; break;
                case 'prev': discrepancyPage = Math.max(1, discrepancyPage - 1); break;
                case 'next': discrepancyPage = Math.min(totalPages, discrepancyPage + 1); break;
                case 'last': discrepancyPage = totalPages; break;
            }
            renderDiscrepanciesTable();
        }

        function changeDiscrepancyPageSize() {
            discrepancyPerPage = parseInt(document.getElementById('discrepancy-per-page').value);
            discrepancyPage = 1; // Reset to first page
            renderDiscrepanciesTable();
        }

        function formatDiscrepancyType(type) {
            const types = {
                'missing_kajabi_record': 'Not in Kajabi',
                'missing_stripe_payment': 'Missing Payment',
                'amount_mismatch': 'Amount Mismatch',
                'failed_payment': 'Failed Payment',
                'duplicate_charge': 'Duplicate',
                'member_not_in_stripe': 'Not in Stripe'
            };
            return types[type] || type;
        }

        function resolveDiscrepancy(id) {
            const discrepancy = appData.discrepancies.find(d => d.id === id);
            if (discrepancy) {
                discrepancy.status = 'resolved';
                discrepancy.resolved_at = new Date().toISOString();
                discrepancy.resolved_by = currentUser.name;
                saveToLocalStorage(true);  // Sync resolved discrepancy to cloud
                renderDiscrepanciesTable();
                refreshDashboard();
            }
        }

        // ============================================
        // REPORTS MODULE (Phase 6)
        // ============================================

        let revenueChart = null;
        let membersChart = null;
        let sourceChart = null;

        function refreshReports() {
            const period = document.getElementById('report-period').value;
            const { startDate, endDate } = getPeriodDates(period);

            // Get filtered data
            const periodTransactions = appData.stripeTransactions.filter(t => {
                const txnDate = new Date(t.transaction_date || t.date);
                return txnDate >= startDate && txnDate <= endDate && t.status === 'succeeded';
            });

            const activeMembers = appData.members.filter(m =>
                (m.subscription_status || m.status) === 'active'
            );

            const canceledMembers = appData.members.filter(m =>
                (m.subscription_status || m.status) === 'canceled'
            );

            // Calculate metrics
            const totalRevenue = periodTransactions.reduce((sum, t) => sum + parseFloat(t.amount || 0), 0);
            const avgRevenue = activeMembers.length > 0 ? totalRevenue / activeMembers.length : 0;

            // Calculate churn (members who canceled in period)
            const newMembers = appData.members.filter(m => {
                const joinDate = new Date(m.join_date || m.joinDate || m.createdAt);
                return joinDate >= startDate && joinDate <= endDate;
            }).length;

            const churnedMembers = canceledMembers.filter(m => {
                // Estimate cancellation from last payment
                const lastPayment = appData.stripeTransactions
                    .filter(t => t.member_email === m.email && t.status === 'succeeded')
                    .sort((a, b) => new Date(b.transaction_date || b.date) - new Date(a.transaction_date || a.date))[0];
                if (!lastPayment) return false;
                const lastPaymentDate = new Date(lastPayment.transaction_date || lastPayment.date);
                return lastPaymentDate >= startDate && lastPaymentDate <= endDate;
            }).length;

            const totalMembersStart = activeMembers.length + churnedMembers - newMembers;
            const churnRate = totalMembersStart > 0 ? ((churnedMembers / totalMembersStart) * 100).toFixed(1) : 0;
            const retentionRate = (100 - parseFloat(churnRate)).toFixed(1);

            // Update stat cards
            document.getElementById('report-total-revenue').textContent = '$' + formatCurrency(totalRevenue);
            document.getElementById('report-total-members').textContent = activeMembers.length;
            document.getElementById('report-avg-revenue').textContent = '$' + formatCurrency(avgRevenue);
            document.getElementById('report-churn-rate').textContent = churnRate + '%';
            document.getElementById('report-churn-rate').className = 'report-stat-value ' + (parseFloat(churnRate) > 5 ? 'negative' : '');

            // Update churn analysis
            document.getElementById('churn-new').textContent = '+' + newMembers;
            document.getElementById('churn-canceled').textContent = '-' + churnedMembers;
            document.getElementById('churn-net').textContent = (newMembers - churnedMembers >= 0 ? '+' : '') + (newMembers - churnedMembers);
            document.getElementById('churn-net').className = 'churn-value ' + (newMembers - churnedMembers >= 0 ? 'positive' : 'negative');
            document.getElementById('churn-retention').textContent = retentionRate + '%';

            // Calculate avg lifetime (months since join for active members)
            const avgLifetime = activeMembers.length > 0 ?
                activeMembers.reduce((sum, m) => {
                    const joinDate = new Date(m.join_date || m.joinDate || m.createdAt || Date.now());
                    const months = Math.max(1, Math.floor((Date.now() - joinDate) / (30 * 24 * 60 * 60 * 1000)));
                    return sum + months;
                }, 0) / activeMembers.length : 0;
            document.getElementById('churn-lifetime').textContent = avgLifetime.toFixed(1) + ' months';

            // Render charts
            renderRevenueChart(periodTransactions);
            renderMembersChart();
            renderSourceChart(periodTransactions);
            renderTopMembersTable();
        }

        function getPeriodDates(period) {
            const now = new Date();
            let startDate, endDate;

            switch (period) {
                case 'this_month':
                    startDate = new Date(now.getFullYear(), now.getMonth(), 1);
                    endDate = new Date(now.getFullYear(), now.getMonth() + 1, 0);
                    break;
                case 'last_month':
                    startDate = new Date(now.getFullYear(), now.getMonth() - 1, 1);
                    endDate = new Date(now.getFullYear(), now.getMonth(), 0);
                    break;
                case 'this_quarter':
                    const q = Math.floor(now.getMonth() / 3);
                    startDate = new Date(now.getFullYear(), q * 3, 1);
                    endDate = new Date(now.getFullYear(), q * 3 + 3, 0);
                    break;
                case 'last_quarter':
                    const lq = Math.floor(now.getMonth() / 3) - 1;
                    const year = lq < 0 ? now.getFullYear() - 1 : now.getFullYear();
                    const quarter = lq < 0 ? 3 : lq;
                    startDate = new Date(year, quarter * 3, 1);
                    endDate = new Date(year, quarter * 3 + 3, 0);
                    break;
                case 'this_year':
                    startDate = new Date(now.getFullYear(), 0, 1);
                    endDate = new Date(now.getFullYear(), 11, 31);
                    break;
                case 'all_time':
                default:
                    startDate = new Date(2020, 0, 1);
                    endDate = now;
            }

            return { startDate, endDate };
        }

        function renderRevenueChart(transactions) {
            const ctx = document.getElementById('revenue-chart');
            if (!ctx) return;

            // Group by month
            const monthlyData = {};
            transactions.forEach(t => {
                const date = new Date(t.transaction_date || t.date);
                const key = date.getFullYear() + '-' + String(date.getMonth() + 1).padStart(2, '0');
                if (!monthlyData[key]) monthlyData[key] = 0;
                monthlyData[key] += parseFloat(t.amount || 0);
            });

            const labels = Object.keys(monthlyData).sort();
            const data = labels.map(k => monthlyData[k]);

            // Format labels to readable months
            const formattedLabels = labels.map(l => {
                const [year, month] = l.split('-');
                return new Date(year, month - 1).toLocaleDateString('en-US', { month: 'short', year: '2-digit' });
            });

            if (revenueChart) revenueChart.destroy();

            revenueChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: formattedLabels,
                    datasets: [{
                        label: 'Revenue',
                        data: data,
                        backgroundColor: 'rgba(0, 168, 225, 0.8)',
                        borderColor: 'rgba(0, 168, 225, 1)',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: value => '$' + value.toLocaleString()
                            }
                        }
                    }
                }
            });
        }

        function renderMembersChart() {
            const ctx = document.getElementById('members-chart');
            if (!ctx) return;

            // Group members by join month
            const monthlyJoins = {};
            const monthlyChurns = {};

            appData.members.forEach(m => {
                const joinDate = new Date(m.join_date || m.joinDate || m.createdAt || Date.now());
                const joinKey = joinDate.getFullYear() + '-' + String(joinDate.getMonth() + 1).padStart(2, '0');
                if (!monthlyJoins[joinKey]) monthlyJoins[joinKey] = 0;
                monthlyJoins[joinKey]++;

                if ((m.subscription_status || m.status) === 'canceled') {
                    // Estimate churn month from last payment
                    const lastPayment = appData.stripeTransactions
                        .filter(t => t.member_email === m.email && t.status === 'succeeded')
                        .sort((a, b) => new Date(b.transaction_date || b.date) - new Date(a.transaction_date || a.date))[0];
                    if (lastPayment) {
                        const churnDate = new Date(lastPayment.transaction_date || lastPayment.date);
                        const churnKey = churnDate.getFullYear() + '-' + String(churnDate.getMonth() + 1).padStart(2, '0');
                        if (!monthlyChurns[churnKey]) monthlyChurns[churnKey] = 0;
                        monthlyChurns[churnKey]++;
                    }
                }
            });

            const allMonths = [...new Set([...Object.keys(monthlyJoins), ...Object.keys(monthlyChurns)])].sort();
            const last12 = allMonths.slice(-12);

            const formattedLabels = last12.map(l => {
                const [year, month] = l.split('-');
                return new Date(year, month - 1).toLocaleDateString('en-US', { month: 'short' });
            });

            if (membersChart) membersChart.destroy();

            membersChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: formattedLabels,
                    datasets: [{
                        label: 'New Members',
                        data: last12.map(k => monthlyJoins[k] || 0),
                        borderColor: 'rgba(5, 150, 105, 1)',
                        backgroundColor: 'rgba(5, 150, 105, 0.1)',
                        fill: true,
                        tension: 0.3
                    }, {
                        label: 'Churned',
                        data: last12.map(k => monthlyChurns[k] || 0),
                        borderColor: 'rgba(220, 38, 38, 1)',
                        backgroundColor: 'rgba(220, 38, 38, 0.1)',
                        fill: true,
                        tension: 0.3
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { position: 'bottom' }
                    },
                    scales: {
                        y: { beginAtZero: true }
                    }
                }
            });
        }

        function renderSourceChart(transactions) {
            const ctx = document.getElementById('source-chart');
            if (!ctx) return;

            // Group by Stripe account
            const bySource = {};
            transactions.forEach(t => {
                const source = t.stripe_account || t.account || 'Unknown';
                if (!bySource[source]) bySource[source] = 0;
                bySource[source] += parseFloat(t.amount || 0);
            });

            const labels = Object.keys(bySource);
            const data = Object.values(bySource);

            if (sourceChart) sourceChart.destroy();

            sourceChart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: labels.map(l => l.charAt(0).toUpperCase() + l.slice(1)),
                    datasets: [{
                        data: data,
                        backgroundColor: [
                            'rgba(0, 168, 225, 0.8)',
                            'rgba(26, 62, 92, 0.8)',
                            'rgba(5, 150, 105, 0.8)',
                            'rgba(217, 119, 6, 0.8)'
                        ],
                        borderWidth: 2,
                        borderColor: '#fff'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { position: 'bottom' }
                    }
                }
            });
        }

        function renderTopMembersTable() {
            const tbody = document.getElementById('top-members-table');
            if (!tbody) return;

            // Calculate total paid per member
            const memberTotals = appData.members.map(m => {
                const payments = appData.stripeTransactions.filter(t =>
                    t.member_email === m.email && t.status === 'succeeded'
                );
                const totalPaid = payments.reduce((sum, p) => sum + parseFloat(p.amount || 0), 0);
                return {
                    ...m,
                    totalPaid,
                    paymentCount: payments.length
                };
            }).sort((a, b) => b.totalPaid - a.totalPaid).slice(0, 10);

            if (memberTotals.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="5" class="text-center text-muted" style="padding: 2rem;">
                            No member data available
                        </td>
                    </tr>
                `;
                return;
            }

            tbody.innerHTML = memberTotals.map(m => `
                <tr>
                    <td>
                        <strong>${escapeHtml(m.name || m.fullName || 'Unknown')}</strong><br>
                        <span class="text-muted" style="font-size: 0.75rem;">${escapeHtml(m.email)}</span>
                    </td>
                    <td>${escapeHtml(m.subscription_plan || m.plan || m.offerName || 'Standard')}</td>
                    <td class="text-success"><strong>$${escapeHtml(formatCurrency(m.totalPaid))}</strong></td>
                    <td>${escapeHtml(m.paymentCount)} payments</td>
                    <td>${escapeHtml(formatDate(m.join_date || m.joinDate || m.createdAt))}</td>
                </tr>
            `).join('');
        }

        function exportReportsToPDF() {
            alert('PDF export coming soon! For now, use your browser\'s Print function (Ctrl/Cmd + P) to save as PDF.');
        }

        // ============================================
        // DATA EXPORT
        // ============================================

        function exportMembers() {
            if (appData.members.length === 0) {
                alert('No members to export.');
                return;
            }

            const csv = Papa.unparse(appData.members);
            downloadFile(csv, 'mastermind-members.csv', 'text/csv');
        }

        function exportAllData() {
            const data = JSON.stringify(appData, null, 2);
            downloadFile(data, 'mastermind-billing-backup.json', 'application/json');
        }

        function downloadFile(content, filename, mimeType) {
            const blob = new Blob([content], { type: mimeType });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        // ============================================
        // BOOKKEEPING FUNCTIONS
        // ============================================

        function importChaseFile() {
            const fileInput = document.getElementById('chase-file');
            const file = fileInput.files[0];

            if (!file) {
                alert('Please select a file.');
                return;
            }

            const fileName = file.name.toLowerCase();

            if (fileName.endsWith('.csv')) {
                importChaseCSV();
            } else if (fileName.endsWith('.pdf')) {
                importChasePDF();
            } else {
                alert('Please select a CSV or PDF file.');
            }
        }

        function importChaseCSV() {
            const fileInput = document.getElementById('chase-file');
            const file = fileInput.files[0];

            if (!file) {
                alert('Please select a CSV file.');
                return;
            }

            Papa.parse(file, {
                header: true,
                skipEmptyLines: true,
                complete: function(results) {
                    processChaseImport(results.data);
                    closeModal('import-chase-modal');
                    fileInput.value = '';
                },
                error: function(error) {
                    alert('Error parsing CSV: ' + error.message);
                }
            });
        }

        async function importChasePDF() {
            const fileInput = document.getElementById('chase-file');
            const file = fileInput.files[0];

            if (!file) {
                alert('Please select a PDF file.');
                return;
            }

            try {
                // Set up PDF.js worker
                pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';

                const arrayBuffer = await file.arrayBuffer();
                const pdf = await pdfjsLib.getDocument({ data: arrayBuffer }).promise;

                let allText = '';
                const transactions = [];

                // Extract text from all pages
                for (let i = 1; i <= pdf.numPages; i++) {
                    const page = await pdf.getPage(i);
                    const textContent = await page.getTextContent();
                    const pageText = textContent.items.map(item => item.str).join(' ');
                    allText += pageText + '\n';
                }

                console.log('PDF text extracted:', allText.substring(0, 500));

                // Parse Chase PDF statement format
                // Chase statements typically have lines like:
                // 01/15 STRIPE TRANSFER 1,234.56
                // or with dates like 01/15/2024

                const lines = allText.split(/\s+/);
                let currentDate = null;
                let i = 0;

                // Common Chase PDF patterns
                // Pattern 1: MM/DD Description Amount
                // Pattern 2: MM/DD/YYYY Description Amount
                const datePattern = /^(\d{1,2}\/\d{1,2}(?:\/\d{2,4})?)$/;
                const amountPattern = /^-?\$?[\d,]+\.\d{2}$/;

                // Try to find transaction patterns in the text
                const transactionRegex = /(\d{1,2}\/\d{1,2}(?:\/\d{2,4})?)\s+(.+?)\s+(-?\$?[\d,]+\.\d{2})/g;
                let match;

                while ((match = transactionRegex.exec(allText)) !== null) {
                    const dateStr = match[1];
                    const description = match[2].trim();
                    const amountStr = match[3];

                    // Skip header rows and summary lines
                    if (description.toLowerCase().includes('beginning balance') ||
                        description.toLowerCase().includes('ending balance') ||
                        description.toLowerCase().includes('account number') ||
                        description.length < 3) {
                        continue;
                    }

                    // Parse amount
                    let amount = parseFloat(amountStr.replace(/[$,]/g, '')) || 0;
                    const isDebit = amount < 0 || amountStr.startsWith('-');
                    amount = Math.abs(amount);

                    if (amount > 0 && description.length > 2) {
                        transactions.push({
                            date: dateStr,
                            description: description.substring(0, 100), // Limit description length
                            amount: amount,
                            type: isDebit ? 'withdrawal' : 'deposit'
                        });
                    }
                }

                // If regex didn't find transactions, try line-by-line parsing
                if (transactions.length === 0) {
                    const lineRegex = /(\d{1,2}\/\d{1,2})\s+(.+?)\s+([\d,]+\.\d{2})\s*([\d,]+\.\d{2})?/g;
                    while ((match = lineRegex.exec(allText)) !== null) {
                        const dateStr = match[1];
                        let description = match[2].trim();
                        const amount1 = parseFloat(match[3].replace(/,/g, '')) || 0;
                        const amount2 = match[4] ? parseFloat(match[4].replace(/,/g, '')) : null;

                        // Chase PDFs sometimes have debit/credit in separate columns
                        // Usually: Date | Description | Debit | Credit | Balance
                        if (description.length > 2 && amount1 > 0) {
                            transactions.push({
                                date: dateStr,
                                description: description.substring(0, 100),
                                amount: amount1,
                                type: amount2 !== null ? 'withdrawal' : 'deposit'
                            });
                        }
                    }
                }

                if (transactions.length === 0) {
                    alert('Could not parse transactions from this PDF.\n\nTry using the CSV export instead:\nChase.com â†’ Account Activity â†’ Download â†’ CSV');
                    return;
                }

                // Process the extracted transactions
                processChasePDFImport(transactions);
                closeModal('import-chase-modal');
                fileInput.value = '';

            } catch (error) {
                console.error('PDF parsing error:', error);
                alert('Error parsing PDF: ' + error.message + '\n\nTry using the CSV export instead.');
            }
        }

        function processChasePDFImport(transactions) {
            const accountName = document.getElementById('chase-account-name').value || 'Chase Business';
            const autoCategorize = document.getElementById('chase-auto-categorize').checked;

            let imported = 0;
            let skipped = 0;
            const currentYear = new Date().getFullYear();

            transactions.forEach(txn => {
                // Parse date - add year if not present
                let dateStr = txn.date;
                if (dateStr.split('/').length === 2) {
                    dateStr = dateStr + '/' + currentYear;
                }

                let transactionDate;
                try {
                    const parts = dateStr.split('/');
                    if (parts.length >= 3) {
                        let year = parseInt(parts[2]);
                        if (year < 100) year += 2000;
                        transactionDate = new Date(year, parseInt(parts[0]) - 1, parseInt(parts[1]));
                    } else {
                        transactionDate = new Date();
                    }
                } catch (e) {
                    transactionDate = new Date();
                }

                // Generate unique ID
                const txnId = `chase_pdf_${transactionDate.toISOString().split('T')[0]}_${txn.description.substring(0, 15).replace(/\s+/g, '_')}_${txn.amount}`;

                // Check for duplicate
                if (appData.bankTransactions.some(t => t.id === txnId)) {
                    skipped++;
                    return;
                }

                // Auto-categorize if enabled
                let categoryId = 'cat_uncategorized';
                if (autoCategorize) {
                    categoryId = autoCategorizeTransaction(txn.description, txn.type);
                }

                const transaction = {
                    id: txnId,
                    account: accountName,
                    date: transactionDate.toISOString(),
                    description: txn.description,
                    amount: txn.amount,
                    type: txn.type,
                    balance: null,
                    category_id: categoryId,
                    details: 'PDF import',
                    is_matched: false,
                    matched_stripe_id: null,
                    created_at: new Date().toISOString()
                };

                appData.bankTransactions.push(transaction);
                imported++;
            });

            // Sort by date descending
            appData.bankTransactions.sort((a, b) => new Date(b.date) - new Date(a.date));

            // Log import
            appData.importLogs.push({
                id: generateId(),
                import_type: 'chase_bank_pdf',
                file_name: document.getElementById('chase-file').files[0]?.name,
                records_imported: imported,
                records_skipped: skipped,
                imported_by: currentUser?.name || 'System',
                imported_at: new Date().toISOString()
            });

            saveToLocalStorage(true);  // Push to Supabase after import
            refreshBookkeeping();

            alert(`Chase PDF import complete!\n\nImported: ${imported}\nSkipped (duplicates): ${skipped}`);
        }

        function processChaseImport(data) {
            const accountName = document.getElementById('chase-account-name').value || 'Chase Business';
            const autoCategorize = document.getElementById('chase-auto-categorize').checked;

            let imported = 0;
            let skipped = 0;

            // Debug: log columns found
            if (data.length > 0) {
                const columns = Object.keys(data[0]);
                console.log('Chase CSV columns found:', columns);
                console.log('First row data:', data[0]);
            }

            // Helper to find column value (case-insensitive)
            function getColumn(row, ...names) {
                for (const name of names) {
                    // Try exact match first
                    if (row[name] !== undefined) return row[name];
                    // Try case-insensitive
                    const key = Object.keys(row).find(k => k.toLowerCase() === name.toLowerCase());
                    if (key) return row[key];
                }
                return '';
            }

            data.forEach(row => {
                // Chase CSV column variations (case-insensitive)
                const dateStr = getColumn(row, 'Posting Date', 'Post Date', 'Transaction Date', 'Date', 'TransactionDate');
                const description = getColumn(row, 'Description', 'Merchant Name', 'Payee', 'Memo', 'Name');
                const amountStr = getColumn(row, 'Amount', 'Transaction Amount', 'Debit', 'Credit');
                const balanceStr = getColumn(row, 'Balance', 'Running Balance', 'Running Bal');
                const details = getColumn(row, 'Details', 'Type', 'Transaction Type', 'Check or Slip #');

                if (!dateStr || !description) {
                    skipped++;
                    return;
                }

                // Parse amount - Chase uses negative for debits
                let amount = parseFloat(String(amountStr).replace(/[$,]/g, '')) || 0;
                const isDebit = amount < 0;
                amount = Math.abs(amount);

                // Parse date (Chase format: MM/DD/YYYY)
                let transactionDate;
                try {
                    const parts = dateStr.split('/');
                    if (parts.length === 3) {
                        transactionDate = new Date(parts[2], parts[0] - 1, parts[1]);
                    } else {
                        transactionDate = new Date(dateStr);
                    }
                } catch (e) {
                    transactionDate = new Date();
                }

                // Generate unique ID based on date + description + amount
                const txnId = `chase_${transactionDate.toISOString().split('T')[0]}_${description.substring(0, 20).replace(/\s+/g, '_')}_${amount}`;

                // Check for duplicate
                if (appData.bankTransactions.some(t => t.id === txnId)) {
                    skipped++;
                    return;
                }

                // Determine transaction type
                const type = isDebit ? 'withdrawal' : 'deposit';

                // Auto-categorize if enabled
                let categoryId = 'cat_uncategorized';
                if (autoCategorize) {
                    categoryId = autoCategorizeTransaction(description, type);
                }

                const transaction = {
                    id: txnId,
                    account: accountName,
                    date: transactionDate.toISOString(),
                    description: description.trim(),
                    amount: amount,
                    type: type,
                    balance: parseFloat(String(balanceStr).replace(/[$,]/g, '')) || null,
                    category_id: categoryId,
                    details: details,
                    is_matched: false,
                    matched_stripe_id: null,
                    created_at: new Date().toISOString()
                };

                appData.bankTransactions.push(transaction);
                imported++;
            });

            // Sort by date descending
            appData.bankTransactions.sort((a, b) => new Date(b.date) - new Date(a.date));

            // Log import
            appData.importLogs.push({
                id: generateId(),
                import_type: 'chase_bank',
                file_name: document.getElementById('chase-file').files[0]?.name,
                records_imported: imported,
                records_skipped: skipped,
                imported_by: currentUser?.name || 'System',
                imported_at: new Date().toISOString()
            });

            saveToLocalStorage(true);  // Sync Chase bank transactions to cloud
            refreshBookkeeping();

            if (imported === 0 && data.length > 0) {
                const columns = Object.keys(data[0]).join(', ');
                alert(`No transactions imported!\n\nColumns found in your CSV:\n${columns}\n\nPlease share these column names so I can fix the import.`);
            } else {
                alert(`Chase import complete!\n\nImported: ${imported}\nSkipped (duplicates): ${skipped}\n\n${autoCategorize ? 'Transactions were auto-categorized.' : ''}`);
            }
        }

        function autoCategorizeTransaction(description, type) {
            const desc = description.toLowerCase();

            // Ensure we have vendor mappings
            if (!appData.vendorMappings || Object.keys(appData.vendorMappings).length === 0) {
                appData.vendorMappings = getDefaultVendorMappings();
            }

            // Check vendor mappings
            for (const [keyword, categoryId] of Object.entries(appData.vendorMappings)) {
                if (desc.includes(keyword.toLowerCase())) {
                    return categoryId;
                }
            }

            // Default category based on type
            if (type === 'deposit') {
                return 'cat_income_other';
            }
            return 'cat_uncategorized';
        }

        function refreshBookkeeping() {
            // Ensure categories exist
            if (!appData.expenseCategories || appData.expenseCategories.length === 0) {
                appData.expenseCategories = getDefaultCategories();
            }

            // Populate category filter dropdown
            populateCategoryDropdowns();

            // Get selected period
            const period = document.getElementById('pl-period-select')?.value || 'this_month';
            const dateRange = getDateRangeForPeriod(period);

            // Filter transactions by period
            const filteredTxns = appData.bankTransactions.filter(t => {
                const txnDate = new Date(t.date);
                return txnDate >= dateRange.start && txnDate <= dateRange.end;
            });

            // Calculate P&L
            const plData = calculatePL(filteredTxns);

            // Update P&L stats
            updatePLStats(plData, dateRange);

            // Render transactions table
            renderBankTransactions(filteredTxns);

            // Render category breakdowns
            renderCategoryBreakdowns(plData);

            // Update Stripe matching stats
            updateStripeMatchStats();
        }

        function getDateRangeForPeriod(period) {
            const now = new Date();
            let start, end;

            switch (period) {
                case 'this_month':
                    start = new Date(now.getFullYear(), now.getMonth(), 1);
                    end = new Date(now.getFullYear(), now.getMonth() + 1, 0, 23, 59, 59);
                    break;
                case 'last_month':
                    start = new Date(now.getFullYear(), now.getMonth() - 1, 1);
                    end = new Date(now.getFullYear(), now.getMonth(), 0, 23, 59, 59);
                    break;
                case 'this_quarter':
                    const quarter = Math.floor(now.getMonth() / 3);
                    start = new Date(now.getFullYear(), quarter * 3, 1);
                    end = new Date(now.getFullYear(), (quarter + 1) * 3, 0, 23, 59, 59);
                    break;
                case 'this_year':
                    start = new Date(now.getFullYear(), 0, 1);
                    end = new Date(now.getFullYear(), 11, 31, 23, 59, 59);
                    break;
                case 'all_time':
                default:
                    start = new Date(2000, 0, 1);
                    end = new Date(2099, 11, 31);
                    break;
            }

            return { start, end };
        }

        function calculatePL(transactions) {
            const income = { total: 0, byCategory: {} };
            const expenses = { total: 0, byCategory: {} };

            transactions.forEach(txn => {
                const category = appData.expenseCategories.find(c => c.id === txn.category_id) ||
                                 { id: 'cat_uncategorized', name: 'Uncategorized', type: 'expense' };

                if (txn.type === 'deposit' || category.type === 'income') {
                    income.total += txn.amount;
                    income.byCategory[category.id] = (income.byCategory[category.id] || 0) + txn.amount;
                } else {
                    expenses.total += txn.amount;
                    expenses.byCategory[category.id] = (expenses.byCategory[category.id] || 0) + txn.amount;
                }
            });

            return {
                income,
                expenses,
                netProfit: income.total - expenses.total,
                margin: income.total > 0 ? ((income.total - expenses.total) / income.total * 100).toFixed(1) : 0
            };
        }

        function updatePLStats(plData, dateRange) {
            // Update period label
            const periodSelect = document.getElementById('pl-period-select');
            const periodLabel = periodSelect?.options[periodSelect.selectedIndex]?.text || 'This Month';
            const periodEl = document.getElementById('pl-period');
            if (periodEl) periodEl.textContent = periodLabel;

            // Update stat values
            const incomeEl = document.getElementById('stat-total-income');
            if (incomeEl) {
                incomeEl.textContent = '$' + formatCurrency(plData.income.total);
                incomeEl.className = 'stat-value positive';
            }

            const expenseEl = document.getElementById('stat-total-expenses');
            if (expenseEl) {
                expenseEl.textContent = '$' + formatCurrency(plData.expenses.total);
                expenseEl.className = 'stat-value negative';
            }

            const netEl = document.getElementById('stat-net-pl');
            if (netEl) {
                netEl.textContent = (plData.netProfit >= 0 ? '+$' : '-$') + formatCurrency(Math.abs(plData.netProfit));
                netEl.className = 'stat-value ' + (plData.netProfit >= 0 ? 'positive' : 'negative');
            }

            const marginEl = document.getElementById('pl-margin');
            if (marginEl) {
                marginEl.textContent = plData.margin + '% margin';
            }

            // Update transaction counts
            const incomeTxns = appData.bankTransactions.filter(t => t.type === 'deposit').length;
            const expenseTxns = appData.bankTransactions.filter(t => t.type === 'withdrawal').length;

            const incomeCountEl = document.getElementById('income-txn-count');
            if (incomeCountEl) incomeCountEl.textContent = incomeTxns + ' deposits';

            const expenseCountEl = document.getElementById('expense-txn-count');
            if (expenseCountEl) expenseCountEl.textContent = expenseTxns + ' transactions';
        }

        function renderBankTransactions(transactions) {
            const tbody = document.getElementById('bank-transactions-table');
            if (!tbody) return;

            // Apply filters
            const search = (document.getElementById('txn-search')?.value || '').toLowerCase();
            const typeFilter = document.getElementById('txn-type-filter')?.value || '';
            const categoryFilter = document.getElementById('txn-category-filter')?.value || '';

            let filtered = transactions;

            if (search) {
                filtered = filtered.filter(t =>
                    t.description.toLowerCase().includes(search)
                );
            }

            if (typeFilter) {
                filtered = filtered.filter(t => t.type === typeFilter);
            }

            if (categoryFilter) {
                filtered = filtered.filter(t => t.category_id === categoryFilter);
            }

            if (filtered.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="7" class="text-center text-muted" style="padding: 3rem;">
                            ${appData.bankTransactions.length === 0
                                ? 'No bank transactions yet. Import a Chase CSV to get started.'
                                : 'No transactions match your filters.'}
                        </td>
                    </tr>
                `;
                return;
            }

            tbody.innerHTML = filtered.slice(0, 100).map(txn => {
                const category = appData.expenseCategories.find(c => c.id === txn.category_id) ||
                                 { name: 'Uncategorized', color: '#94a3b8' };

                return `
                    <tr>
                        <td>${escapeHtml(formatDate(txn.date))}</td>
                        <td style="max-width: 300px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;" title="${escapeHtml(txn.description)}">${escapeHtml(txn.description)}</td>
                        <td>
                            <span class="badge" style="background: ${escapeHtml(category.color)}20; color: ${escapeHtml(category.color)}; border: 1px solid ${escapeHtml(category.color)}40;">
                                ${escapeHtml(category.name)}
                            </span>
                        </td>
                        <td class="${txn.type === 'deposit' ? 'positive' : 'negative'}">
                            ${txn.type === 'deposit' ? '+' : '-'}$${escapeHtml(formatCurrency(txn.amount))}
                        </td>
                        <td>${txn.balance ? '$' + escapeHtml(formatCurrency(txn.balance)) : '-'}</td>
                        <td>
                            ${txn.is_matched
                                ? '<span class="badge badge-success">Matched</span>'
                                : txn.type === 'deposit' && txn.category_id === 'cat_income_stripe'
                                    ? '<span class="badge badge-warning">Pending</span>'
                                    : '-'}
                        </td>
                        <td>
                            <button class="btn btn-sm btn-outline" data-txn-id="${escapeHtml(txn.id)}" onclick="openEditCategoryModal(this.dataset.txnId)">Edit</button>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        function filterBankTransactions() {
            const period = document.getElementById('pl-period-select')?.value || 'this_month';
            const dateRange = getDateRangeForPeriod(period);
            const filteredTxns = appData.bankTransactions.filter(t => {
                const txnDate = new Date(t.date);
                return txnDate >= dateRange.start && txnDate <= dateRange.end;
            });
            renderBankTransactions(filteredTxns);
        }

        function renderCategoryBreakdowns(plData) {
            // Income breakdown
            const incomeContainer = document.getElementById('income-breakdown');
            if (incomeContainer) {
                if (Object.keys(plData.income.byCategory).length === 0) {
                    incomeContainer.innerHTML = '<div class="empty-state"><div class="empty-state-message">No income data yet</div></div>';
                } else {
                    incomeContainer.innerHTML = Object.entries(plData.income.byCategory)
                        .sort((a, b) => b[1] - a[1])
                        .map(([catId, amount]) => {
                            const category = appData.expenseCategories.find(c => c.id === catId) || { name: catId, color: '#10b981' };
                            const percent = (amount / plData.income.total * 100).toFixed(1);
                            return `
                                <div style="display: flex; align-items: center; justify-content: space-between; padding: 0.5rem 0; border-bottom: 1px solid var(--gray-100);">
                                    <div style="display: flex; align-items: center; gap: 0.5rem;">
                                        <span style="width: 12px; height: 12px; border-radius: 3px; background: ${escapeHtml(category.color)};"></span>
                                        <span>${escapeHtml(category.name)}</span>
                                    </div>
                                    <div style="text-align: right;">
                                        <div style="font-weight: 600; color: var(--success);">$${escapeHtml(formatCurrency(amount))}</div>
                                        <div style="font-size: 0.75rem; color: var(--gray-500);">${escapeHtml(percent)}%</div>
                                    </div>
                                </div>
                            `;
                        }).join('');
                }
            }

            // Expense breakdown
            const expenseContainer = document.getElementById('expense-breakdown');
            if (expenseContainer) {
                if (Object.keys(plData.expenses.byCategory).length === 0) {
                    expenseContainer.innerHTML = '<div class="empty-state"><div class="empty-state-message">No expense data yet</div></div>';
                } else {
                    expenseContainer.innerHTML = Object.entries(plData.expenses.byCategory)
                        .sort((a, b) => b[1] - a[1])
                        .map(([catId, amount]) => {
                            const category = appData.expenseCategories.find(c => c.id === catId) || { name: catId, color: '#dc2626' };
                            const percent = (amount / plData.expenses.total * 100).toFixed(1);
                            return `
                                <div style="display: flex; align-items: center; justify-content: space-between; padding: 0.5rem 0; border-bottom: 1px solid var(--gray-100);">
                                    <div style="display: flex; align-items: center; gap: 0.5rem;">
                                        <span style="width: 12px; height: 12px; border-radius: 3px; background: ${escapeHtml(category.color)};"></span>
                                        <span>${escapeHtml(category.name)}</span>
                                    </div>
                                    <div style="text-align: right;">
                                        <div style="font-weight: 600; color: var(--danger);">$${escapeHtml(formatCurrency(amount))}</div>
                                        <div style="font-size: 0.75rem; color: var(--gray-500);">${escapeHtml(percent)}%</div>
                                    </div>
                                </div>
                            `;
                        }).join('');
                }
            }
        }

        function populateCategoryDropdowns() {
            const categories = appData.expenseCategories || getDefaultCategories();
            const incomeCategories = categories.filter(c => c.type === 'income');
            const expenseCategories = categories.filter(c => c.type === 'expense');

            // Transaction filter dropdown
            const filterSelect = document.getElementById('txn-category-filter');
            if (filterSelect) {
                filterSelect.innerHTML = '<option value="">All Categories</option>' +
                    '<optgroup label="Income">' +
                    incomeCategories.map(c => `<option value="${c.id}">${c.name}</option>`).join('') +
                    '</optgroup>' +
                    '<optgroup label="Expenses">' +
                    expenseCategories.map(c => `<option value="${c.id}">${c.name}</option>`).join('') +
                    '</optgroup>';
            }

            // Add transaction modal category dropdown
            const newTxnSelect = document.getElementById('txn-new-category');
            if (newTxnSelect) {
                newTxnSelect.innerHTML = '<option value="">Select category...</option>' +
                    '<optgroup label="Income">' +
                    incomeCategories.map(c => `<option value="${c.id}">${c.name}</option>`).join('') +
                    '</optgroup>' +
                    '<optgroup label="Expenses">' +
                    expenseCategories.map(c => `<option value="${c.id}">${c.name}</option>`).join('') +
                    '</optgroup>';
            }

            // Edit category modal dropdown
            const editCatSelect = document.getElementById('edit-cat-select');
            if (editCatSelect) {
                editCatSelect.innerHTML = '<option value="">Select category...</option>' +
                    '<optgroup label="Income">' +
                    incomeCategories.map(c => `<option value="${c.id}">${c.name}</option>`).join('') +
                    '</optgroup>' +
                    '<optgroup label="Expenses">' +
                    expenseCategories.map(c => `<option value="${c.id}">${c.name}</option>`).join('') +
                    '</optgroup>';
            }

            // Vendor mapping category dropdown
            const vendorCatSelect = document.getElementById('new-vendor-category');
            if (vendorCatSelect) {
                vendorCatSelect.innerHTML = '<option value="">Select category...</option>' +
                    '<optgroup label="Income">' +
                    incomeCategories.map(c => `<option value="${c.id}">${c.name}</option>`).join('') +
                    '</optgroup>' +
                    '<optgroup label="Expenses">' +
                    expenseCategories.map(c => `<option value="${c.id}">${c.name}</option>`).join('') +
                    '</optgroup>';
            }
        }

        function openEditCategoryModal(txnId) {
            const txn = appData.bankTransactions.find(t => t.id === txnId);
            if (!txn) return;

            document.getElementById('edit-cat-txn-id').value = txnId;
            document.getElementById('edit-cat-txn-desc').textContent = txn.description.substring(0, 50) + (txn.description.length > 50 ? '...' : '');
            document.getElementById('edit-cat-select').value = txn.category_id || '';
            document.getElementById('edit-cat-remember').checked = false;

            populateCategoryDropdowns();
            openModal('edit-category-modal');
        }

        function saveTransactionCategory() {
            const txnId = document.getElementById('edit-cat-txn-id').value;
            const categoryId = document.getElementById('edit-cat-select').value;
            const remember = document.getElementById('edit-cat-remember').checked;

            const txn = appData.bankTransactions.find(t => t.id === txnId);
            if (!txn) return;

            txn.category_id = categoryId;

            // If "remember" is checked, add to vendor mappings
            if (remember && categoryId) {
                // Extract vendor keyword from description
                const keyword = txn.description.split(' ')[0].toLowerCase();
                if (keyword.length > 2) {
                    appData.vendorMappings[keyword] = categoryId;
                }
            }

            saveToLocalStorage(true);  // Sync category changes to cloud
            closeModal('edit-category-modal');
            refreshBookkeeping();
        }

        function addManualTransaction() {
            const date = document.getElementById('txn-date').value;
            const description = document.getElementById('txn-description').value;
            const amount = parseFloat(document.getElementById('txn-amount').value);
            const type = document.getElementById('txn-type').value;
            const categoryId = document.getElementById('txn-new-category').value;
            const notes = document.getElementById('txn-notes').value;

            if (!date || !description || !amount) {
                alert('Please fill in date, description, and amount.');
                return;
            }

            const transaction = {
                id: 'manual_' + generateId(),
                account: 'Manual Entry',
                date: new Date(date).toISOString(),
                description: description,
                amount: amount,
                type: type,
                balance: null,
                category_id: categoryId || 'cat_uncategorized',
                details: 'Manual entry' + (notes ? ': ' + notes : ''),
                is_matched: false,
                matched_stripe_id: null,
                created_at: new Date().toISOString()
            };

            appData.bankTransactions.push(transaction);
            appData.bankTransactions.sort((a, b) => new Date(b.date) - new Date(a.date));

            saveToLocalStorage(true);  // Sync manual transaction to cloud
            closeModal('add-transaction-modal');

            // Reset form
            document.getElementById('txn-date').value = '';
            document.getElementById('txn-description').value = '';
            document.getElementById('txn-amount').value = '';
            document.getElementById('txn-notes').value = '';

            refreshBookkeeping();
            alert('Transaction added successfully!');
        }

        // ============================================
        // STRIPE PAYOUT MATCHING
        // ============================================

        function matchStripePayouts() {
            // Get all Stripe transactions that are payouts/transfers
            const stripePayouts = appData.stripeTransactions.filter(t =>
                t.status === 'succeeded' && t.net_amount > 0
            );

            // Get all bank deposits that might be Stripe payouts
            const bankDeposits = appData.bankTransactions.filter(t =>
                t.type === 'deposit' &&
                (t.category_id === 'cat_income_stripe' ||
                 t.description.toLowerCase().includes('stripe') ||
                 !t.is_matched)
            );

            let matched = 0;
            let unmatched = 0;
            const matches = [];

            // For each bank deposit, try to find matching Stripe payout
            bankDeposits.forEach(deposit => {
                const depositDate = new Date(deposit.date);
                const depositAmount = deposit.amount;

                // Look for Stripe transactions within 5 days of the deposit
                // with matching or close amount (Stripe payouts can aggregate)
                const potentialMatches = stripePayouts.filter(payout => {
                    const payoutDate = new Date(payout.transaction_date);
                    const daysDiff = (depositDate - payoutDate) / (1000 * 60 * 60 * 24);

                    // Payout should be 1-5 days before deposit
                    return daysDiff >= 0 && daysDiff <= 5;
                });

                // Try to find exact amount match first
                let match = potentialMatches.find(p => Math.abs(p.net_amount - depositAmount) < 0.01);

                // If no exact match, look for close matches (within $1)
                if (!match) {
                    match = potentialMatches.find(p => Math.abs(p.net_amount - depositAmount) < 1);
                }

                if (match) {
                    deposit.is_matched = true;
                    deposit.matched_stripe_id = match.stripe_id;
                    deposit.category_id = 'cat_income_stripe';
                    matched++;

                    matches.push({
                        stripe_date: match.transaction_date,
                        stripe_amount: match.net_amount,
                        chase_date: deposit.date,
                        chase_amount: deposit.amount,
                        difference: Math.abs(match.net_amount - deposit.amount),
                        status: 'matched'
                    });
                } else if (deposit.description.toLowerCase().includes('stripe')) {
                    unmatched++;
                    matches.push({
                        stripe_date: null,
                        stripe_amount: null,
                        chase_date: deposit.date,
                        chase_amount: deposit.amount,
                        difference: null,
                        status: 'unmatched'
                    });
                }
            });

            // Store matches
            appData.stripePayoutMatches = matches;
            saveToLocalStorage(true);  // Sync payout matches to cloud

            // Render match table
            renderPayoutMatchTable(matches);
            updateStripeMatchStats();

            alert(`Stripe Payout Matching Complete!\n\nMatched: ${matched}\nUnmatched: ${unmatched}`);
        }

        function renderPayoutMatchTable(matches) {
            const tbody = document.getElementById('payout-match-table');
            if (!tbody) return;

            if (matches.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="6" class="text-center text-muted" style="padding: 2rem;">
                            No matches found. Import both Stripe and Chase data, then click "Match Stripe Payouts".
                        </td>
                    </tr>
                `;
                return;
            }

            tbody.innerHTML = matches.map(m => `
                <tr>
                    <td>${escapeHtml(m.stripe_date ? formatDate(m.stripe_date) : '-')}</td>
                    <td>${m.stripe_amount ? '$' + escapeHtml(formatCurrency(m.stripe_amount)) : '-'}</td>
                    <td>${escapeHtml(formatDate(m.chase_date))}</td>
                    <td>$${escapeHtml(formatCurrency(m.chase_amount))}</td>
                    <td>${m.difference !== null ? '$' + escapeHtml(m.difference.toFixed(2)) : '-'}</td>
                    <td>
                        <span class="badge ${m.status === 'matched' ? 'badge-success' : 'badge-warning'}">
                            ${m.status === 'matched' ? 'Matched' : 'Unmatched'}
                        </span>
                    </td>
                </tr>
            `).join('');

            // Update match status badge
            const matchStatus = document.getElementById('match-status');
            if (matchStatus) {
                const matchedCount = matches.filter(m => m.status === 'matched').length;
                matchStatus.textContent = `${matchedCount}/${matches.length} Matched`;
                matchStatus.className = matchedCount === matches.length ? 'badge badge-success' : 'badge badge-warning';
            }
        }

        function updateStripeMatchStats() {
            const matches = appData.stripePayoutMatches || [];
            const matchedCount = matches.filter(m => m.status === 'matched').length;
            const totalCount = matches.length;

            const statEl = document.getElementById('stat-stripe-matches');
            if (statEl) {
                statEl.textContent = `${matchedCount}/${totalCount}`;
            }

            const unmatchedEl = document.getElementById('unmatched-payouts');
            if (unmatchedEl) {
                const unmatched = totalCount - matchedCount;
                unmatchedEl.textContent = `${unmatched} unmatched payout${unmatched !== 1 ? 's' : ''}`;
            }
        }

        // ============================================
        // CATEGORY MANAGEMENT
        // ============================================

        function openManageCategoriesModal() {
            renderCategoriesList();
            openModal('manage-categories-modal');
        }

        function renderCategoriesList() {
            const container = document.getElementById('categories-list');
            if (!container) return;

            const categories = appData.expenseCategories || getDefaultCategories();
            const incomeCategories = categories.filter(c => c.type === 'income');
            const expenseCategories = categories.filter(c => c.type === 'expense');

            container.innerHTML = `
                <h4 style="font-size: 0.875rem; margin-bottom: 0.5rem; color: var(--success);">Income Categories</h4>
                ${incomeCategories.map(c => `
                    <div style="display: flex; align-items: center; justify-content: space-between; padding: 0.5rem; background: var(--gray-50); border-radius: var(--radius-sm); margin-bottom: 0.25rem;">
                        <div style="display: flex; align-items: center; gap: 0.5rem;">
                            <span style="width: 16px; height: 16px; border-radius: 3px; background: ${escapeHtml(c.color)};"></span>
                            <span>${escapeHtml(c.name)}</span>
                        </div>
                        ${c.id.startsWith('cat_') ? '' : `<button class="btn btn-sm btn-danger" data-cat-id="${escapeHtml(c.id)}" onclick="deleteCategory(this.dataset.catId)" style="padding: 0.25rem 0.5rem;">&times;</button>`}
                    </div>
                `).join('')}

                <h4 style="font-size: 0.875rem; margin: 1rem 0 0.5rem; color: var(--danger);">Expense Categories</h4>
                ${expenseCategories.map(c => `
                    <div style="display: flex; align-items: center; justify-content: space-between; padding: 0.5rem; background: var(--gray-50); border-radius: var(--radius-sm); margin-bottom: 0.25rem;">
                        <div style="display: flex; align-items: center; gap: 0.5rem;">
                            <span style="width: 16px; height: 16px; border-radius: 3px; background: ${escapeHtml(c.color)};"></span>
                            <span>${escapeHtml(c.name)}</span>
                        </div>
                        ${c.id.startsWith('cat_') ? '' : `<button class="btn btn-sm btn-danger" data-cat-id="${escapeHtml(c.id)}" onclick="deleteCategory(this.dataset.catId)" style="padding: 0.25rem 0.5rem;">&times;</button>`}
                    </div>
                `).join('')}
            `;
        }

        function addCategory() {
            const name = document.getElementById('new-cat-name').value.trim();
            const type = document.getElementById('new-cat-type').value;
            const color = document.getElementById('new-cat-color').value;

            if (!name) {
                alert('Please enter a category name.');
                return;
            }

            const newCategory = {
                id: 'custom_' + generateId(),
                name: name,
                type: type,
                color: color
            };

            appData.expenseCategories.push(newCategory);
            saveToLocalStorage(true);  // Sync new category to cloud

            document.getElementById('new-cat-name').value = '';
            renderCategoriesList();
            populateCategoryDropdowns();
        }

        function deleteCategory(catId) {
            if (confirm('Delete this category? Transactions with this category will be set to Uncategorized.')) {
                appData.expenseCategories = appData.expenseCategories.filter(c => c.id !== catId);

                // Update transactions with deleted category
                appData.bankTransactions.forEach(t => {
                    if (t.category_id === catId) {
                        t.category_id = 'cat_uncategorized';
                    }
                });

                saveToLocalStorage(true);  // Sync category deletion to cloud
                renderCategoriesList();
                populateCategoryDropdowns();
                refreshBookkeeping();
            }
        }

        // ============================================
        // VENDOR MAPPINGS
        // ============================================

        function openVendorMappingsModal() {
            renderVendorMappingsList();
            openModal('vendor-mappings-modal');
        }

        function renderVendorMappingsList() {
            const container = document.getElementById('vendor-mappings-list');
            if (!container) return;

            const mappings = appData.vendorMappings || {};
            const sortedKeys = Object.keys(mappings).sort();

            if (sortedKeys.length === 0) {
                container.innerHTML = '<p class="text-muted">No vendor mappings configured.</p>';
                return;
            }

            container.innerHTML = sortedKeys.map(keyword => {
                const catId = mappings[keyword];
                const category = appData.expenseCategories.find(c => c.id === catId) || { name: catId, color: '#94a3b8' };

                return `
                    <div style="display: flex; align-items: center; justify-content: space-between; padding: 0.5rem; background: var(--gray-50); border-radius: var(--radius-sm); margin-bottom: 0.25rem;">
                        <div>
                            <strong style="font-family: monospace;">${escapeHtml(keyword)}</strong>
                            <span style="color: var(--gray-400); margin: 0 0.5rem;">â†’</span>
                            <span class="badge" style="background: ${escapeHtml(category.color)}20; color: ${escapeHtml(category.color)};">${escapeHtml(category.name)}</span>
                        </div>
                        <button class="btn btn-sm btn-outline" data-keyword="${escapeHtml(keyword)}" onclick="deleteVendorMapping(this.dataset.keyword)" style="padding: 0.25rem 0.5rem;">&times;</button>
                    </div>
                `;
            }).join('');
        }

        function addVendorMapping() {
            const keyword = document.getElementById('new-vendor-keyword').value.trim().toLowerCase();
            const categoryId = document.getElementById('new-vendor-category').value;

            if (!keyword || !categoryId) {
                alert('Please enter both a keyword and select a category.');
                return;
            }

            appData.vendorMappings[keyword] = categoryId;
            saveToLocalStorage(true);  // Sync vendor mapping to cloud

            document.getElementById('new-vendor-keyword').value = '';
            document.getElementById('new-vendor-category').value = '';
            renderVendorMappingsList();
        }

        function deleteVendorMapping(keyword) {
            delete appData.vendorMappings[keyword];
            saveToLocalStorage(true);  // Sync vendor mapping deletion to cloud
            renderVendorMappingsList();
        }

        function resetVendorMappings() {
            if (confirm('Reset all vendor mappings to defaults? Custom mappings will be lost.')) {
                appData.vendorMappings = getDefaultVendorMappings();
                saveToLocalStorage(true);  // Sync vendor mappings reset to cloud
                renderVendorMappingsList();
            }
        }

        // ============================================
        // P&L REPORT EXPORT
        // ============================================

        function exportPLReport() {
            const period = document.getElementById('pl-period-select')?.value || 'this_month';
            const dateRange = getDateRangeForPeriod(period);

            const filteredTxns = appData.bankTransactions.filter(t => {
                const txnDate = new Date(t.date);
                return txnDate >= dateRange.start && txnDate <= dateRange.end;
            });

            const plData = calculatePL(filteredTxns);

            // Build report
            let report = `PROFIT & LOSS REPORT\n`;
            report += `Period: ${document.getElementById('pl-period-select')?.options[document.getElementById('pl-period-select')?.selectedIndex]?.text}\n`;
            report += `Generated: ${new Date().toLocaleDateString()}\n`;
            report += `${'='.repeat(50)}\n\n`;

            report += `INCOME\n`;
            report += `${'-'.repeat(30)}\n`;
            Object.entries(plData.income.byCategory).forEach(([catId, amount]) => {
                const category = appData.expenseCategories.find(c => c.id === catId) || { name: catId };
                report += `${category.name.padEnd(25)} $${formatCurrency(amount)}\n`;
            });
            report += `${'='.repeat(30)}\n`;
            report += `Total Income:             $${formatCurrency(plData.income.total)}\n\n`;

            report += `EXPENSES\n`;
            report += `${'-'.repeat(30)}\n`;
            Object.entries(plData.expenses.byCategory).forEach(([catId, amount]) => {
                const category = appData.expenseCategories.find(c => c.id === catId) || { name: catId };
                report += `${category.name.padEnd(25)} $${formatCurrency(amount)}\n`;
            });
            report += `${'='.repeat(30)}\n`;
            report += `Total Expenses:           $${formatCurrency(plData.expenses.total)}\n\n`;

            report += `${'='.repeat(50)}\n`;
            report += `NET PROFIT/LOSS:          ${plData.netProfit >= 0 ? '+' : ''}$${formatCurrency(plData.netProfit)}\n`;
            report += `Profit Margin:            ${plData.margin}%\n`;

            downloadFile(report, `pl-report-${period}.txt`, 'text/plain');
        }

        // ============================================
        // SECURITY UTILITY FUNCTIONS
        // ============================================

        /**
         * Escapes HTML special characters to prevent XSS attacks
         * Use this for any user-controlled data inserted into HTML
         */
        function escapeHtml(text) {
            if (text === null || text === undefined) return '';
            const str = String(text);
            const htmlEscapes = {
                '&': '&amp;',
                '<': '&lt;',
                '>': '&gt;',
                '"': '&quot;',
                "'": '&#39;',
                '/': '&#x2F;',
                '`': '&#x60;',
                '=': '&#x3D;'
            };
            return str.replace(/[&<>"'`=\/]/g, char => htmlEscapes[char]);
        }

        /**
         * Escapes data for safe use in HTML attributes
         * Use this for onclick handlers and other attribute values
         */
        function escapeAttr(text) {
            if (text === null || text === undefined) return '';
            return String(text).replace(/['"\\]/g, '\\$&');
        }

        // ============================================
        // UTILITY FUNCTIONS
        // ============================================

        function generateId() {
            return 'id_' + Math.random().toString(36).substr(2, 9) + Date.now().toString(36);
        }

        function formatCurrency(amount) {
            return (parseFloat(amount) || 0).toLocaleString('en-US', {
                minimumFractionDigits: 0,
                maximumFractionDigits: 0
            });
        }

        function formatDate(dateString) {
            if (!dateString) return '-';
            const date = new Date(dateString);
            return date.toLocaleDateString('en-US', {
                month: 'short',
                day: 'numeric',
                year: 'numeric'
            });
        }

        function getInitials(name) {
            if (!name) return '?';
            return name.split(' ')
                .map(part => part.charAt(0).toUpperCase())
                .slice(0, 2)
                .join('');
        }
    </script>
</body>
</html>
